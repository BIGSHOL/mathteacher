"""
ìê¸° ì‹œí—˜ ëŒ€ë¹„ ì „ëµ ìƒì„± AI ì—ì´ì „íŠ¸

ì•ìœ¼ë¡œ ìˆì„ ì‹œí—˜ì„ ëŒ€ë¹„í•œ ë§ì¶¤ ì „ëµì„ ìƒì„±í•©ë‹ˆë‹¤.
- Gemini API ìš°ì„  ì‚¬ìš©
- ì‹¤íŒ¨ ì‹œ ê·œì¹™ ê¸°ë°˜ ì „ëµ ì œê³µ
"""

import json
import os
from datetime import datetime
from typing import TypedDict

from app.services.prompt_config import (
    ESSAY_GRADING_GUIDE,
    SCORE_LEVEL_STRATEGIES,
    PREREQUISITE_MAPPING,
)

try:
    import google.generativeai as genai

    genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
except ImportError:
    genai = None


class PriorityAreaData(TypedDict):
    topic: str
    reason: str
    key_points: list[str]
    estimated_hours: int


class DailyPlanData(TypedDict):
    day_label: str
    focus: str
    activities: list[str]
    time_allocation: str
    dos: list[str]
    donts: list[str]


class ExamDayStrategyData(TypedDict):
    before_exam: list[str]
    during_exam: list[str]
    time_management: list[str]
    stress_management: list[str]


class ExamPrepStrategyData(TypedDict):
    exam_name: str
    days_until_exam: int
    target_score_improvement: str
    priority_areas: list[PriorityAreaData]
    daily_plans: list[DailyPlanData]
    exam_day_strategy: ExamDayStrategyData
    final_advice: str


class ExamPrepStrategyAgent:
    """ìê¸° ì‹œí—˜ ëŒ€ë¹„ ì „ëµ ìƒì„± ì—ì´ì „íŠ¸"""

    def __init__(self):
        self.client = None
        if genai:
            try:
                self.client = genai.GenerativeModel("gemini-2.0-flash-exp")
            except Exception as e:
                print(f"[ExamPrepStrategyAgent] Failed to initialize Gemini: {e}")

    def generate(
        self,
        analysis_data: dict,
        exam_name: str = "ë‹¤ìŒ ì‹œí—˜",
        days_until_exam: int = 7
    ) -> ExamPrepStrategyData:
        """ë¶„ì„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹œí—˜ ëŒ€ë¹„ ì „ëµ ìƒì„±

        Args:
            analysis_data: {
                "questions": [...],  # ë¬¸í•­ ë¶„ì„ ê²°ê³¼
                "summary": {...},    # ìš”ì•½ í†µê³„
                "current_score": int,
                "total_score": int
            }
            exam_name: ì‹œí—˜ ì´ë¦„
            days_until_exam: ì‹œí—˜ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜

        Returns:
            ExamPrepStrategyData
        """
        if not self.client:
            return self._rule_based_strategy(analysis_data, exam_name, days_until_exam)

        try:
            return self._ai_strategy(analysis_data, exam_name, days_until_exam)
        except Exception as e:
            print(f"AI exam prep strategy generation failed: {e}, falling back to rule-based")
            return self._rule_based_strategy(analysis_data, exam_name, days_until_exam)

    def _ai_strategy(
        self,
        analysis_data: dict,
        exam_name: str,
        days_until_exam: int
    ) -> ExamPrepStrategyData:
        """AI ê¸°ë°˜ ì‹œí—˜ ëŒ€ë¹„ ì „ëµ ìƒì„±"""
        questions = analysis_data.get("questions", [])
        current_score = analysis_data.get("current_score", 0)
        total_score = analysis_data.get("total_score", 100)

        # ì·¨ì•½ ë‹¨ì› ë¶„ì„
        topic_errors = {}
        for q in questions:
            if not q.get("is_correct") and q.get("topic"):
                topic = q["topic"]
                if topic not in topic_errors:
                    topic_errors[topic] = {"count": 0, "questions": []}
                topic_errors[topic]["count"] += 1
                topic_errors[topic]["questions"].append(q.get("question_number"))

        # ë‚œì´ë„ë³„ ì˜¤ë‹µ ë¶„ì„
        difficulty_errors = {}
        for q in questions:
            if not q.get("is_correct"):
                diff = q.get("difficulty", "medium")
                difficulty_errors[diff] = difficulty_errors.get(diff, 0) + 1

        # í”„ë¡¬í”„íŠ¸ êµ¬ì„±
        prompt = self._build_ai_prompt(
            exam_name,
            days_until_exam,
            current_score,
            total_score,
            topic_errors,
            difficulty_errors,
            questions
        )

        # Gemini API í˜¸ì¶œ
        response = self.client.generate_content(
            prompt,
            generation_config=genai.GenerationConfig(
                temperature=0.6,
                response_mime_type="application/json",
            ),
        )

        result = json.loads(response.text)
        result["exam_name"] = exam_name
        result["days_until_exam"] = days_until_exam

        return result

    def _build_ai_prompt(
        self,
        exam_name: str,
        days_until_exam: int,
        current_score: int,
        total_score: int,
        topic_errors: dict,
        difficulty_errors: dict,
        questions: list
    ) -> str:
        """AI í”„ë¡¬í”„íŠ¸ êµ¬ì„±"""
        # ì·¨ì•½ ë‹¨ì› ìš”ì•½
        weak_topics_str = "\n".join([
            f"  - {topic}: {data['count']}ë¬¸í•­ ì˜¤ë‹µ"
            for topic, data in sorted(topic_errors.items(), key=lambda x: x[1]['count'], reverse=True)
        ]) if topic_errors else "  (ì˜¤ë‹µ ì—†ìŒ)"

        # ë‚œì´ë„ë³„ ì˜¤ë‹µ
        diff_errors_str = "\n".join([
            f"  - {diff}: {count}ë¬¸í•­"
            for diff, count in difficulty_errors.items()
        ]) if difficulty_errors else "  (ì˜¤ë‹µ ì—†ìŒ)"

        score_percentage = int((current_score / total_score * 100)) if total_score > 0 else 0

        prompt = f"""ë‹¹ì‹ ì€ ìˆ˜í•™ êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í•™ìƒì´ **{exam_name}**ì„ **D-{days_until_exam}** ì•ë‘ê³  ìˆìŠµë‹ˆë‹¤. íš¨ê³¼ì ì¸ ì‹œí—˜ ëŒ€ë¹„ ì „ëµì„ ì œê³µí•˜ì„¸ìš”.

## í˜„ì¬ ìƒíƒœ
- í˜„ì¬ ì ìˆ˜: {current_score}/{total_score}ì  ({score_percentage}%)
- ì‹œí—˜ê¹Œì§€: D-{days_until_exam}

## ì·¨ì•½ ë‹¨ì›
{weak_topics_str}

## ë‚œì´ë„ë³„ ì˜¤ë‹µ
{diff_errors_str}

## ìš”êµ¬ì‚¬í•­

1. **ëª©í‘œ ì ìˆ˜ í–¥ìƒ** (target_score_improvement):
   - í˜„ì¬ ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ í˜„ì‹¤ì ì¸ ëª©í‘œ ì œì‹œ (ì˜ˆ: "10-15ì  í–¥ìƒ")

2. **ìš°ì„  í•™ìŠµ ì˜ì—­** (priority_areas):
   - 2-5ê°œì˜ ìš°ì„  í•™ìŠµ ì˜ì—­ ì„ ì • (ì·¨ì•½ ë‹¨ì› ì¤‘ì‹¬)
   - ê° ì˜ì—­ë§ˆë‹¤:
     - topic: ë‹¨ì›ëª…
     - reason: ì™œ ìš°ì„ ìˆœìœ„ì¸ì§€
     - key_points: ì§‘ì¤‘ í•™ìŠµ í¬ì¸íŠ¸ 2-5ê°œ
     - estimated_hours: ì˜ˆìƒ í•™ìŠµ ì‹œê°„

3. **ì¼ë³„ í•™ìŠµ ê³„íš** (daily_plans):
   - D-dayì— ë§ì¶° 2-7ê°œì˜ ì¼ë³„ ê³„íš (ì˜ˆ: D-7, D-5, D-3, D-1, D-day)
   - ê° ê³„íšë§ˆë‹¤:
     - day_label: ë‚ ì§œ ë ˆì´ë¸”
     - focus: ë‹¹ì¼ ì§‘ì¤‘ ì‚¬í•­
     - activities: êµ¬ì²´ì ì¸ í™œë™ 2-6ê°œ
     - time_allocation: ì‹œê°„ ë°°ë¶„
     - dos: í•´ì•¼ í•  ê²ƒ 2-4ê°œ
     - donts: í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒ 2-4ê°œ

4. **ì‹œí—˜ ë‹¹ì¼ ì „ëµ** (exam_day_strategy):
   - before_exam: ì‹œí—˜ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸ 3-5ê°œ
   - during_exam: ì‹œí—˜ ì¤‘ ì „ëµ 3-6ê°œ
   - time_management: ì‹œê°„ ê´€ë¦¬ íŒ 2-4ê°œ
   - stress_management: ê¸´ì¥ ì™„í™” ë°©ë²• 2-4ê°œ

5. **ë§ˆì§€ë§‰ ì¡°ì–¸** (final_advice):
   - ì‹œí—˜ì„ ì•ë‘” í•™ìƒì—ê²Œ ì „í•˜ëŠ” ì¡°ì–¸ (2-3ë¬¸ì¥)

## ì¶œë ¥ í˜•ì‹ (JSON)
{{
  "target_score_improvement": "ëª©í‘œ ì ìˆ˜ í–¥ìƒ",
  "priority_areas": [
    {{
      "topic": "ë‹¨ì›ëª…",
      "reason": "ìš°ì„ ìˆœìœ„ ì´ìœ ",
      "key_points": ["í¬ì¸íŠ¸1", "í¬ì¸íŠ¸2", ...],
      "estimated_hours": 3
    }}
  ],
  "daily_plans": [
    {{
      "day_label": "D-7",
      "focus": "ì§‘ì¤‘ ì‚¬í•­",
      "activities": ["í™œë™1", "í™œë™2", ...],
      "time_allocation": "3ì‹œê°„",
      "dos": ["í•  ê²ƒ1", "í•  ê²ƒ2", ...],
      "donts": ["í•˜ì§€ ë§ ê²ƒ1", "í•˜ì§€ ë§ ê²ƒ2", ...]
    }}
  ],
  "exam_day_strategy": {{
    "before_exam": ["ì²´í¬1", "ì²´í¬2", ...],
    "during_exam": ["ì „ëµ1", "ì „ëµ2", ...],
    "time_management": ["íŒ1", "íŒ2", ...],
    "stress_management": ["ë°©ë²•1", "ë°©ë²•2", ...]
  }},
  "final_advice": "ë§ˆì§€ë§‰ ì¡°ì–¸"
}}

## ì£¼ì˜ì‚¬í•­
- ë‚¨ì€ ê¸°ê°„({days_until_exam}ì¼)ì— ë§ëŠ” í˜„ì‹¤ì ì¸ ê³„íšì„ ì œì‹œí•  ê²ƒ
- êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì „ëµì„ ì œê³µí•  ê²ƒ
- í•™ìƒì˜ í˜„ì¬ ìˆ˜ì¤€({score_percentage}%)ì„ ê³ ë ¤í•  ê²ƒ
- ì‹œí—˜ ë‹¹ì¼ ì‹¤ì „ íŒì„ êµ¬ì²´ì ìœ¼ë¡œ ì œê³µí•  ê²ƒ

{ESSAY_GRADING_GUIDE}

## ìˆ˜ì¤€ë³„ í•™ìŠµ ì „ëµ (ì ìˆ˜ëŒ€ì— ë§ëŠ” ì „ëµ ì œì‹œ!)
"""
        # ìˆ˜ì¤€ë³„ ì „ëµ (configì—ì„œ ì°¸ì¡°)
        for level_name, level_data in SCORE_LEVEL_STRATEGIES.items():
            strategies_str = "\n".join(f"- {s}" for s in level_data["strategies"])
            prompt += f"""
### {level_name} ({level_data['range']})
**í•µì‹¬ ì›ì¹™:** {level_data['principle']}
{strategies_str}
"""
        prompt += f"""

## 4ì£¼ í•™ìŠµ íƒ€ì„ë¼ì¸ (D-28 ~ D-day)

D-dayê¹Œì§€ ë‚¨ì€ ê¸°ê°„ì— ë”°ë¼ ì ì ˆí•œ íƒ€ì„ë¼ì¸ì„ ì œì‹œí•˜ì„¸ìš”:

### D-28 ~ D-22 (4ì£¼ ì „) - ğŸ“– ê°œë… ì •ë³µ ì£¼ê°„
**ëª©í‘œ: ì „ì²´ ë²”ìœ„ ê°œë… ì™„ì „ ì´í•´**

| í™œë™ | ì„¸ë¶€ ë‚´ìš© | ì‹œê°„ ë°°ë¶„ |
|------|----------|----------|
| êµê³¼ì„œ ì •ë… | ìˆ˜ì—… í•„ê¸° ì •ë¦¬ì™€ í•¨ê»˜ êµê³¼ì„œ 1íšŒë… | í•˜ë£¨ 2ì‹œê°„ |
| ê°œë…ì„œ 1íšŒë… | ìˆ/RPM ë“± ê°œë…ì„œ ì˜ˆì œ í’€ì´ | í•˜ë£¨ 1ì‹œê°„ |
| ê°œë… ë…¸íŠ¸ ì‘ì„± | í•µì‹¬ ê³µì‹+ì˜ˆì œ+ì£¼ì˜ì‚¬í•­ ì •ë¦¬ | í•˜ë£¨ 30ë¶„ |
| ì·¨ì•½ ë‹¨ì› í‘œì‹œ | ì´í•´ ì•ˆ ë˜ëŠ” ë¶€ë¶„ ë³„ë„ ë§ˆí‚¹ | í•™ìŠµ ì¤‘ ìˆ˜ì‹œ |

**ì²´í¬í¬ì¸íŠ¸:**
- [ ] ì „ì²´ ë²”ìœ„ êµê³¼ì„œ 1íšŒë… ì™„ë£Œ
- [ ] ê°œë… ë…¸íŠ¸ ì´ˆì•ˆ ì‘ì„± ì™„ë£Œ
- [ ] ì·¨ì•½ ë‹¨ì› 3ê°œ ì´ë‚´ë¡œ íŒŒì•…

### D-21 ~ D-15 (3ì£¼ ì „) - ğŸ“ ìœ í˜• ì •ë³µ ì£¼ê°„
**ëª©í‘œ: ë¬¸ì œ ìœ í˜• ìµíˆê¸° + ì˜¤ë‹µ ë¶„ë¥˜ ì‹œì‘**

| í™œë™ | ì„¸ë¶€ ë‚´ìš© | ì‹œê°„ ë°°ë¶„ |
|------|----------|----------|
| ìœ í˜•ì„œ í’€ì´ | ë‹¨ì›ë³„ ëŒ€í‘œ ìœ í˜• ë¬¸ì œ í’€ì´ | í•˜ë£¨ 2ì‹œê°„ |
| ì˜¤ë‹µ ë¶„ë¥˜ | 3ê°€ì§€ë¡œ ë¶„ë¥˜: ê³„ì‚°ì‹¤ìˆ˜/ê°œë…ë¶€ì¡±/ì ‘ê·¼ë¶ˆê°€ | í’€ì´ í›„ ì¦‰ì‹œ |
| ê°œë… 2íšŒë… | ì·¨ì•½ ë‹¨ì› ì¤‘ì‹¬ ê°œë… ì¬í•™ìŠµ | í•˜ë£¨ 1ì‹œê°„ |
| ê¸°ì¶œ ë¶„ì„ | ì¶œì œ ê²½í–¥ íŒŒì•… (ìì£¼ ë‚˜ì˜¤ëŠ” ìœ í˜•) | í•˜ë£¨ 30ë¶„ |

**ì˜¤ë‹µ ë¶„ë¥˜ ê¸°ì¤€ (ì¤‘ìš”!):**
- ğŸ”´ **ê³„ì‚°ì‹¤ìˆ˜**: ê°œë…ì€ ì•Œì§€ë§Œ ì‹¤ìˆ˜ â†’ ê²€ì‚° ìŠµê´€ í•„ìš”
- ğŸŸ¡ **ê°œë…ë¶€ì¡±**: í’€ì´ ë°©ë²• ëª¨ë¦„ â†’ ê°œë… ì¬í•™ìŠµ í•„ìš”
- âš« **ì ‘ê·¼ë¶ˆê°€**: ë¬¸ì œ ì´í•´ ìì²´ ì‹¤íŒ¨ â†’ ìœ í˜• ì•”ê¸° í•„ìš”

**ì²´í¬í¬ì¸íŠ¸:**
- [ ] ìœ í˜•ì„œ ì „ì²´ ë²”ìœ„ 1íšŒë… ì™„ë£Œ
- [ ] ì˜¤ë‹µ ë¶„ë¥˜í‘œ ì‘ì„± ì™„ë£Œ
- [ ] ì·¨ì•½ ìœ í˜• Top 5 íŒŒì•…

### D-14 ~ D-8 (2ì£¼ ì „) - ğŸ¯ ì‹¤ì „ í›ˆë ¨ ì£¼ê°„
**ëª©í‘œ: ê¸°ì¶œ í’€ì´ + ì„œìˆ í˜• ë‹µì•ˆ ì‘ì„± ì—°ìŠµ**

| í™œë™ | ì„¸ë¶€ ë‚´ìš© | ì‹œê°„ ë°°ë¶„ |
|------|----------|----------|
| ê¸°ì¶œ ë¬¸ì œ í’€ì´ | ì‹œê°„ ì¬ë©° ì‹¤ì „ì²˜ëŸ¼ í’€ê¸° | í•˜ë£¨ 2-3ì‹œê°„ |
| ì„œìˆ í˜• ì‘ì„± ì—°ìŠµ | 4ë‹¨ê³„ êµ¬ì¡° ì§€í‚¤ë©° í’€ì´ ì‘ì„± | í•˜ë£¨ 1ì‹œê°„ |
| ëª¨ì˜ê³ ì‚¬ ì—°ìŠµ | ì£¼ 2íšŒ ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ | íšŒë‹¹ 50ë¶„ |
| ì˜¤ë‹µ ë…¸íŠ¸ ì •ë¦¬ | ë¶„ë¥˜ë³„ ì˜¤ë‹µ ì›ì¸+í•´ê²°ì±… ì •ë¦¬ | í’€ì´ í›„ ì¦‰ì‹œ |

**ì„œìˆ í˜• 4ë‹¨ê³„ í•„ìˆ˜ ì²´í¬:**
1. âœ… ë¯¸ì§€ìˆ˜ ì„¤ì • ("~ì„ xë¼ í•˜ë©´")
2. âœ… ì‹ ìˆ˜ë¦½ (ì¡°ê±´â†’ë°©ì •ì‹)
3. âœ… ê³„ì‚° ê³¼ì • (ë‹¨ê³„ë³„ ì „ê°œ)
4. âœ… ë‹µ ë„ì¶œ ("âˆ´ ë‹µ: ~")

**ì²´í¬í¬ì¸íŠ¸:**
- [ ] ê¸°ì¶œ ë¬¸ì œ ìµœì†Œ 5íšŒë¶„ í’€ì´ ì™„ë£Œ
- [ ] ì„œìˆ í˜• 4ë‹¨ê³„ êµ¬ì¡° ì²´í™”
- [ ] ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ 2íšŒ ì´ìƒ ì™„ë£Œ

### D-7 ~ D-4 (1ì£¼ ì „) - ğŸ”¥ ì·¨ì•½ì  ë³´ì™„ ì£¼ê°„
**ëª©í‘œ: ì˜¤ë‹µ ì •ë³µ + ë°±ì§€ ë³µìŠµ**

| í™œë™ | ì„¸ë¶€ ë‚´ìš© | ì‹œê°„ ë°°ë¶„ |
|------|----------|----------|
| ì˜¤ë‹µ ë…¸íŠ¸ ë³µìŠµ | ë¶„ë¥˜ë³„ ì˜¤ë‹µ ì§‘ì¤‘ ë³µìŠµ | í•˜ë£¨ 1.5ì‹œê°„ |
| ë°±ì§€ ë³µìŠµ | í•µì‹¬ ê³µì‹+í’€ì´ë²• ë°±ì§€ì— ì“°ê¸° | í•˜ë£¨ 30ë¶„ |
| ì·¨ì•½ ìœ í˜• ë°˜ë³µ | ì ‘ê·¼ë¶ˆê°€â†’ê°œë…ë¶€ì¡±â†’ê³„ì‚°ì‹¤ìˆ˜ ìˆœ | í•˜ë£¨ 1ì‹œê°„ |
| ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ | ìµœì¢… ì ê²€ìš© 2-3íšŒ | ê²©ì¼ 1íšŒ |

**ë°±ì§€ ë³µìŠµ ë°©ë²•:**
1. ê°œë… ë…¸íŠ¸ ë³´ì§€ ì•Šê³  í•µì‹¬ ê³µì‹ ì ê¸°
2. ëŒ€í‘œ ë¬¸ì œ í’€ì´ ê³¼ì • ì ê¸°
3. ëª» ì“´ ë¶€ë¶„ í™•ì¸ í›„ ì¬ì•”ê¸°

**ì²´í¬í¬ì¸íŠ¸:**
- [ ] ì˜¤ë‹µ ë…¸íŠ¸ 2íšŒë… ì™„ë£Œ
- [ ] ë°±ì§€ ë³µìŠµìœ¼ë¡œ ê³µì‹ 90% ì¬í˜„ ê°€ëŠ¥
- [ ] ì·¨ì•½ ìœ í˜• ì •ë‹µë¥  70% ì´ìƒ ë‹¬ì„±

### D-3 ~ D-2 (ì§ì „ 3ì¼) - ğŸ§˜ ë§ˆë¬´ë¦¬ ì •ë¦¬
**ëª©í‘œ: ìì‹ ê° íšŒë³µ + ì»¨ë””ì…˜ ê´€ë¦¬**

| í™œë™ | ì„¸ë¶€ ë‚´ìš© | ì‹œê°„ ë°°ë¶„ |
|------|----------|----------|
| ì˜¤ë‹µ ë…¸íŠ¸ ìµœì¢… ë³µìŠµ | ê°€ë³ê²Œ í›‘ê¸°ë§Œ | í•˜ë£¨ 1ì‹œê°„ |
| í•µì‹¬ ê³µì‹ ì•”ê¸° | ë°±ì§€ ë³µìŠµ ìµœì¢… | í•˜ë£¨ 30ë¶„ |
| ì‰¬ìš´ ë¬¸ì œ í’€ì´ | ìì‹ ê° ìœ ì§€ìš© | í•˜ë£¨ 30ë¶„ |
| ì»¨ë””ì…˜ ê´€ë¦¬ | 8ì‹œê°„ ìˆ˜ë©´, ê°€ë²¼ìš´ ìš´ë™ | í•„ìˆ˜ |

**í•˜ì§€ ë§ ê²ƒ:**
- âŒ ìƒˆë¡œìš´ ë¬¸ì œ í’€ì§€ ì•Šê¸°
- âŒ ì–´ë ¤ìš´ ë¬¸ì œë¡œ ìì‹ ê° ê¹ì§€ ì•Šê¸°
- âŒ ë°¤ëŠ¦ê²Œê¹Œì§€ ê³µë¶€í•˜ì§€ ì•Šê¸°

### D-1 (ì „ë‚ ) - ğŸ˜´ íœ´ì‹ & ì ê²€
**ëª©í‘œ: ì»¨ë””ì…˜ ìµœìƒìœ¼ë¡œ**

| í™œë™ | ì„¸ë¶€ ë‚´ìš© | ì‹œê°„ ë°°ë¶„ |
|------|----------|----------|
| ê³µì‹ ìµœì¢… í™•ì¸ | ê°œë… ë…¸íŠ¸ ê°€ë³ê²Œ í›‘ê¸° | 30ë¶„ ì´ë‚´ |
| ì‹œí—˜ ì¤€ë¹„ë¬¼ ì ê²€ | í•„ê¸°êµ¬, ì‹œê³„, ìˆ˜í—˜í‘œ | 15ë¶„ |
| ì¼ì° ì·¨ì¹¨ | í‰ì†Œë³´ë‹¤ 1ì‹œê°„ ì¼ì° | 22ì‹œ ì´ì „ |

### D-day (ë‹¹ì¼) - ğŸ’ª ì‹¤ì „ ëŒì…
**ëª©í‘œ: í‰ìƒì‹¬ ìœ ì§€ + ì‹¤ë ¥ ë°œíœ˜**

| ì‹œì  | í•  ì¼ |
|------|------|
| ê¸°ìƒ ì§í›„ | ê°€ë³ê²Œ ìŠ¤íŠ¸ë ˆì¹­, ì•„ì¹¨ ì‹ì‚¬ |
| ì¶œë°œ ì „ | í•µì‹¬ ê³µì‹ 5ê°œë§Œ í™•ì¸ (30ë¶„ ì´ë‚´) |
| ì‹œí—˜ì¥ ë„ì°© | 30ë¶„ ì „ ë„ì°©, í™”ì¥ì‹¤ ë‹¤ë…€ì˜¤ê¸° |
| ì‹œí—˜ ì§ì „ | ì‹¬í˜¸í¡ 3íšŒ, "í•  ìˆ˜ ìˆë‹¤" ìê¸°ì•”ì‹œ |

{PREREQUISITE_MAPPING}

í•˜ìœ„ê¶Œ(50% ì´í•˜) í•™ìƒì˜ ê²½ìš°, ê³ ë“±í•™êµ ë‹¨ì› ì·¨ì•½ì ì˜ ì›ì¸ì´ ì¤‘í•™êµ ì„ ìˆ˜ ê°œë… ë¶€ì¡±ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì·¨ì•½ ë‹¨ì›ì— ë”°ë¼ ì¤‘í•™êµ ë³µìŠµì„ ê¶Œì¥í•˜ì„¸ìš”.
"""

        return prompt

    def _rule_based_strategy(
        self,
        analysis_data: dict,
        exam_name: str,
        days_until_exam: int
    ) -> ExamPrepStrategyData:
        """ê·œì¹™ ê¸°ë°˜ ì‹œí—˜ ëŒ€ë¹„ ì „ëµ ìƒì„± (AI ì‹¤íŒ¨ ì‹œ ëŒ€ì²´)"""
        questions = analysis_data.get("questions", [])
        current_score = analysis_data.get("current_score", 0)
        total_score = analysis_data.get("total_score", 100)

        score_percentage = int((current_score / total_score * 100)) if total_score > 0 else 0

        # ì·¨ì•½ ë‹¨ì› ë¶„ì„
        topic_errors = {}
        for q in questions:
            if not q.get("is_correct") and q.get("topic"):
                topic = q["topic"]
                topic_errors[topic] = topic_errors.get(topic, 0) + 1

        # ìƒìœ„ ì·¨ì•½ ë‹¨ì› ì„ ì •
        weak_topics = sorted(topic_errors.items(), key=lambda x: x[1], reverse=True)[:5]

        # ìš°ì„  í•™ìŠµ ì˜ì—­
        priority_areas: list[PriorityAreaData] = []

        # ìˆ˜ì¤€ë³„ ë§ì¶¤ í•™ìŠµ ì „ëµ ì¶”ê°€
        if score_percentage < 50:
            # í•˜ìœ„ê¶Œ: ê¸°ì´ˆ ê°œë… + ì¤‘í•™êµ ì—°ê³„
            priority_areas.append({
                "topic": "ê¸°ì´ˆ ê°œë… ë³µìŠµ",
                "reason": f"í˜„ì¬ {score_percentage}% - ê¸°ì´ˆë¶€í„° ì°¨ê·¼ì°¨ê·¼ ë‹¤ì§€ê¸° í•„ìš”",
                "key_points": [
                    "ì¤‘í•™êµ ì—°ê³„ ê°œë… ë³µìŠµ (ì—°ë¦½ë°©ì •ì‹, ì¸ìˆ˜ë¶„í•´, í•¨ìˆ˜ ê¸°ì´ˆ)",
                    "ì‰¬ìš´ ê°œë…ì„œë¡œ ê¸°ì´ˆ ë‹¤ì§€ê¸° (1íšŒë…: ê°œë…, 2íšŒë…: ìœ í˜•, 3íšŒë…: ì™„ì „ ì´í•´)",
                    "ì‰¬ìš´ ë¬¸ì œ(ë‚œì´ë„ í•˜~ì¤‘) ì •ë‹µë¥  90% ëª©í‘œ",
                    "ì˜¤ë‹µë…¸íŠ¸: ê°œë… ë¹ˆí‹ˆ ìœ„ì£¼ë¡œ ì‘ì„±"
                ],
                "estimated_hours": 6
            })
        elif score_percentage < 80:
            # ì¤‘ìœ„ê¶Œ: ê¸°ë³¸ê¸° ê°•í™” + ìœ í˜• ì™„ì„±
            priority_areas.append({
                "topic": "ìœ í˜• ì™„ì„± ì „ëµ",
                "reason": f"í˜„ì¬ {score_percentage}% - ê¸°ë³¸ê¸° ê°•í™”ë¡œ ë“±ê¸‰ ìƒìŠ¹ ê°€ëŠ¥",
                "key_points": [
                    "5ë‹¨ê³„ í•™ìŠµë²•: ì˜ˆìŠµâ†’ìˆ˜ì—…â†’ë³µìŠµâ†’ë¬¸ì œí’€ì´â†’ì˜¤ë‹µê´€ë¦¬",
                    "ìµœì†Œ 10íšŒë¶„ ì—°ìŠµ ì‹œí—˜ì§€ ì‹œê°„ ì¬ë©° í’€ê¸°",
                    "ì‹¤ìˆ˜ ìœ í˜• ë¦¬ìŠ¤íŠ¸ ì‘ì„±í•˜ì—¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ í™œìš©",
                    "ì·¨ì•½ ë‹¨ì›: ê°œë… ì¬í•™ìŠµ í›„ ìœ ì‚¬ ë¬¸ì œ 10ê°œ+ í’€ê¸°"
                ],
                "estimated_hours": 4
            })
        else:
            # ìƒìœ„ê¶Œ: ë§Œì  ì „ëµ + ì‹¤ìˆ˜ ì œë¡œ
            priority_areas.append({
                "topic": "ë§Œì  ì „ëµ",
                "reason": f"í˜„ì¬ {score_percentage}% - ì‹¤ìˆ˜ë§Œ ì¤„ì´ë©´ ë§Œì  ê°€ëŠ¥",
                "key_points": [
                    "ê³ ë‚œë„ ë¬¸ì œ(reasoning, creative) ì§‘ì¤‘ í›ˆë ¨",
                    "ì—°ê³„ ë‹¨ì› ë³µí•© ë¬¸ì œ ì—°ìŠµ",
                    "ë‹¤ì–‘í•œ í’€ì´ë²• ìŠµë“ (ì‹œê°„ ì ˆì•½ í’€ì´ í¬í•¨)",
                    "ì‹¤ìˆ˜ ë°©ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë§¤ ë¬¸ì œë§ˆë‹¤ í™•ì¸"
                ],
                "estimated_hours": 3
            })

        # ì·¨ì•½ ë‹¨ì›ë³„ ì˜ì—­ ì¶”ê°€
        for topic, count in weak_topics[:3]:
            priority_areas.append({
                "topic": topic,
                "reason": f"{count}ë¬¸í•­ì„ í‹€ë ¤ ê°€ì¥ ì·¨ì•½í•œ ì˜ì—­ì…ë‹ˆë‹¤",
                "key_points": [
                    f"{topic} ê¸°ë³¸ ê°œë… ì •ë¦¬",
                    f"{topic} í•µì‹¬ ê³µì‹ ì•”ê¸°",
                    f"{topic} ëŒ€í‘œ ë¬¸ì œ ìœ í˜• ì—°ìŠµ"
                ],
                "estimated_hours": min(count * 2, 6)
            })

        # ì„œìˆ í˜• ì˜¤ë‹µì´ ìˆëŠ” ê²½ìš° ì„œìˆ í˜• ëŒ€ë¹„ ì˜ì—­ ì¶”ê°€
        essay_wrong = [q for q in questions if q.get("question_format") == "essay" and not q.get("is_correct")]
        if essay_wrong:
            priority_areas.append({
                "topic": "ì„œìˆ í˜• ë‹µì•ˆ ì‘ì„±ë²•",
                "reason": f"ì„œìˆ í˜• {len(essay_wrong)}ë¬¸í•­ ì˜¤ë‹µ - ë¶€ë¶„ì ìˆ˜ í™•ë³´ ì „ëµ í•„ìš”",
                "key_points": [
                    "í’€ì´ ê³¼ì • ìƒëµí•˜ì§€ ì•Šê¸° (40-60% ë°°ì )",
                    "ë…¼ë¦¬ì  íë¦„ ëª…ì‹œí•˜ê¸° (â†’, â‡” ê¸°í˜¸ í™œìš©)",
                    "ë‹¨ìœ„ í‘œê¸° ë° ìµœì¢…ë‹µ ëª…í™•íˆ ì ê¸°",
                    "ì¡°ê±´ ì¶©ì¡± ì—¬ë¶€ í™•ì¸í•˜ëŠ” ê²€ì‚° ìŠµê´€",
                    "ë™ì¹˜ ê´€ê³„ vs í’€ì´ ìˆœì„œ êµ¬ë¶„í•˜ì—¬ í‘œí˜„"
                ],
                "estimated_hours": max(2, len(essay_wrong))
            })

        if not priority_areas:
            # ì˜¤ë‹µì´ ì—†ëŠ” ê²½ìš°
            base_areas: list[PriorityAreaData] = [
                {
                    "topic": "ê³ ë‚œë„ ë¬¸ì œ",
                    "reason": "ì‹¤ë ¥ í–¥ìƒì„ ìœ„í•œ ë„ì „",
                    "key_points": [
                        "ì°½ì˜ì  ì‚¬ê³  ìš”êµ¬ ë¬¸ì œ ì—°ìŠµ",
                        "ë³µí•© ê°œë… ì ìš© ë¬¸ì œ í’€ì´",
                        "ì‹œê°„ ê´€ë¦¬ ì—°ìŠµ"
                    ],
                    "estimated_hours": 4
                },
                {
                    "topic": "ì‹¤ìˆ˜ ë°©ì§€",
                    "reason": "ë§Œì ì„ ìœ„í•œ ë§ˆë¬´ë¦¬",
                    "key_points": [
                        "ê²€ì‚° ìŠµê´€ ê¸°ë¥´ê¸°",
                        "ë¬¸ì œ ì¡°ê±´ ê¼¼ê¼¼íˆ ì½ê¸°",
                        "ê³„ì‚° ì‹¤ìˆ˜ ì¤„ì´ê¸°"
                    ],
                    "estimated_hours": 2
                }
            ]

            # ì„œìˆ í˜• ë¬¸í•­ì´ ìˆìœ¼ë©´ ì„œìˆ í˜• ëŒ€ë¹„ë„ ì¶”ê°€
            all_essay = [q for q in questions if q.get("question_format") == "essay"]
            if all_essay:
                base_areas.append({
                    "topic": "ì„œìˆ í˜• ì™„ë²½ ëŒ€ë¹„",
                    "reason": f"ì„œìˆ í˜• {len(all_essay)}ë¬¸í•­ ë§Œì  ì „ëµ",
                    "key_points": [
                        "í’€ì´ ê³¼ì • ë…¼ë¦¬ì ìœ¼ë¡œ ì „ê°œí•˜ê¸°",
                        "ê°ì  ìš”ì¸(ë¹„ì•½, ë‹¨ìœ„ ëˆ„ë½) ì²´í¬ë¦¬ìŠ¤íŠ¸ í™œìš©",
                        "ì‹œê°„ ë‚´ ê²€ì‚°ê¹Œì§€ ì™„ë£Œí•˜ëŠ” ì—°ìŠµ"
                    ],
                    "estimated_hours": 2
                })

            priority_areas = base_areas

        # ì¼ë³„ ê³„íš ìƒì„± (4ì£¼ íƒ€ì„ë¼ì¸ ì§€ì›)
        daily_plans: list[DailyPlanData] = []

        # D-28 ~ D-22 (4ì£¼ ì „) - ê°œë… ì •ë³µ ì£¼ê°„
        if days_until_exam >= 28:
            daily_plans.append({
                "day_label": "D-28",
                "focus": "ğŸ“– ê°œë… ì •ë³µ ì£¼ê°„: êµê³¼ì„œ ì •ë… + ê°œë…ì„œ 1íšŒë…",
                "activities": [
                    "êµê³¼ì„œ ì •ë… (ìˆ˜ì—… í•„ê¸°ì™€ í•¨ê»˜)",
                    "ê°œë…ì„œ(ìˆ/RPM ë“±) ì˜ˆì œ í’€ì´",
                    "ê°œë… ë…¸íŠ¸ ì‘ì„± (í•µì‹¬ ê³µì‹+ì˜ˆì œ+ì£¼ì˜ì‚¬í•­)",
                    "ì·¨ì•½ ë‹¨ì› íŒŒì•… ë° ë³„ë„ ë§ˆí‚¹",
                    "ê¸°ë³¸ ë¬¸ì œë¡œ ê°œë… ì´í•´ë„ í™•ì¸"
                ],
                "time_allocation": "í•˜ë£¨ 3ì‹œê°„ (êµê³¼ì„œ 2h + ê°œë…ì„œ 1h)",
                "dos": [
                    "êµê³¼ì„œì™€ ìˆ˜ì—… í•„ê¸° í•¨ê»˜ ì •ë¦¬í•˜ê¸°",
                    "ì´í•´ ì•ˆ ë˜ëŠ” ë¶€ë¶„ ì¦‰ì‹œ í‘œì‹œí•˜ê¸°",
                    "ê°œë… ë…¸íŠ¸ì— 'ì™œ?'ë¥¼ í•¨ê»˜ ì ê¸°"
                ],
                "donts": [
                    "í•œ ë‹¨ì›ì— 2ì‹œê°„ ì´ìƒ ë¨¸ë¬¼ì§€ ì•Šê¸°",
                    "ì–´ë ¤ìš´ ë¬¸ì œ í’€ì§€ ì•Šê¸° (ê°œë… í™•ì¸ìš©ë§Œ)",
                    "ì•”ê¸°ë§Œ í•˜ê³  ì´í•´ ê±´ë„ˆë›°ì§€ ì•Šê¸°"
                ]
            })

        # D-21 ~ D-15 (3ì£¼ ì „) - ìœ í˜• ì •ë³µ ì£¼ê°„
        if days_until_exam >= 21:
            daily_plans.append({
                "day_label": "D-21",
                "focus": "ğŸ“ ìœ í˜• ì •ë³µ ì£¼ê°„: ìœ í˜•ì„œ + ì˜¤ë‹µ ë¶„ë¥˜ ì‹œì‘",
                "activities": [
                    "ìœ í˜•ì„œ ë‹¨ì›ë³„ ëŒ€í‘œ ìœ í˜• ë¬¸ì œ í’€ì´",
                    "ì˜¤ë‹µ 3ë¶„ë¥˜: ğŸ”´ê³„ì‚°ì‹¤ìˆ˜ / ğŸŸ¡ê°œë…ë¶€ì¡± / âš«ì ‘ê·¼ë¶ˆê°€",
                    "ì·¨ì•½ ë‹¨ì› ê°œë… ì¬í•™ìŠµ",
                    "ê¸°ì¶œ ë¬¸ì œ ë¶„ì„ (ì¶œì œ ê²½í–¥ íŒŒì•…)",
                    "ì¤‘ìš” ìœ í˜• ë³„ë„ ì •ë¦¬"
                ],
                "time_allocation": "í•˜ë£¨ 3ì‹œê°„ (ìœ í˜•ì„œ 2h + ê°œë… 1h)",
                "dos": [
                    "ì˜¤ë‹µ ì¦‰ì‹œ ë¶„ë¥˜í•˜ê³  ì›ì¸ ì ê¸°",
                    "ì¶œì œ ë¹ˆë„ ë†’ì€ ìœ í˜• ìš°ì„  í•™ìŠµ",
                    "ê°œë…ë¶€ì¡± ì˜¤ë‹µì€ ê°œë… ì¬í•™ìŠµ í›„ ì¬í’€ì´"
                ],
                "donts": [
                    "ì˜¤ë‹µ ë¶„ë¥˜ ì—†ì´ ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ì§€ ì•Šê¸°",
                    "ì ‘ê·¼ë¶ˆê°€ ë¬¸ì œì— 30ë¶„ ì´ìƒ ì“°ì§€ ì•Šê¸°",
                    "ê¸°ì¶œ ë¶„ì„ ì—†ì´ ë¬´ì‘ì • í’€ì§€ ì•Šê¸°"
                ]
            })

        # D-14 ~ D-8 (2ì£¼ ì „) - ì‹¤ì „ í›ˆë ¨ ì£¼ê°„
        if days_until_exam >= 14:
            daily_plans.append({
                "day_label": "D-14",
                "focus": "ğŸ¯ ì‹¤ì „ í›ˆë ¨ ì£¼ê°„: ê¸°ì¶œ + ì„œìˆ í˜• ì‘ì„± ì—°ìŠµ",
                "activities": [
                    "ê¸°ì¶œ ë¬¸ì œ ì‹œê°„ ì¬ë©° ì‹¤ì „ì²˜ëŸ¼ í’€ê¸°",
                    "ì„œìˆ í˜• 4ë‹¨ê³„ êµ¬ì¡° ì—°ìŠµ (ë¯¸ì§€ìˆ˜â†’ì‹ìˆ˜ë¦½â†’ê³„ì‚°â†’ë‹µ)",
                    "ì£¼ 2íšŒ ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ (50ë¶„ íƒ€ì´ë¨¸)",
                    "ì˜¤ë‹µ ë…¸íŠ¸ ì •ë¦¬ (ì›ì¸+í•´ê²°ì±…)",
                    "ì„œìˆ í˜• ë‹µì•ˆ ìê°€ ì±„ì  ì—°ìŠµ"
                ],
                "time_allocation": "í•˜ë£¨ 3-4ì‹œê°„ (ê¸°ì¶œ 2h + ì„œìˆ í˜• 1h + ë³µìŠµ 1h)",
                "dos": [
                    "ì„œìˆ í˜•ì€ 4ë‹¨ê³„ ë¹ ì§ì—†ì´ ì‘ì„±í•˜ê¸°",
                    "ì‹¤ì „ì²˜ëŸ¼ ì‹œê°„ ì¬ë©° í’€ê¸°",
                    "í‹€ë¦° ë¬¸ì œ ì›ì¸ ë¶„ë¥˜í•˜ì—¬ ê¸°ë¡"
                ],
                "donts": [
                    "ì„œìˆ í˜• ê³¼ì • ìƒëµí•˜ì§€ ì•Šê¸° (50% ê°ì  ìœ„í—˜)",
                    "ê°œë… ê³µë¶€ì— ë§ì€ ì‹œê°„ ì“°ì§€ ì•Šê¸°",
                    "ë‹µë§Œ ë§íˆê³  í’€ì´ ê³¼ì • í™•ì¸ ì•ˆ í•˜ê¸°"
                ]
            })

        # D-7 (1ì£¼ ì „) - ì·¨ì•½ì  ë³´ì™„ ì£¼ê°„
        if days_until_exam >= 7:
            daily_plans.append({
                "day_label": "D-7",
                "focus": "ğŸ”¥ ì·¨ì•½ì  ë³´ì™„ ì£¼ê°„: ì˜¤ë‹µ ì •ë³µ + ë°±ì§€ ë³µìŠµ",
                "activities": [
                    "ì˜¤ë‹µ ë…¸íŠ¸ ì§‘ì¤‘ ë³µìŠµ (ì ‘ê·¼ë¶ˆê°€â†’ê°œë…ë¶€ì¡±â†’ê³„ì‚°ì‹¤ìˆ˜ ìˆœ)",
                    "ë°±ì§€ ë³µìŠµ: í•µì‹¬ ê³µì‹ì„ ë³´ì§€ ì•Šê³  ì ì–´ë³´ê¸°",
                    "ì·¨ì•½ ìœ í˜• ë°˜ë³µ í’€ì´",
                    "ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ 2-3íšŒ (ìµœì¢… ì ê²€)",
                    "ì•”ê¸° í•„ìš” ê³µì‹ ìµœì¢… ì •ë¦¬"
                ],
                "time_allocation": "í•˜ë£¨ 3ì‹œê°„ (ì˜¤ë‹µ 1.5h + ë°±ì§€ë³µìŠµ 30m + ëª¨ì˜ê³ ì‚¬ 1h)",
                "dos": [
                    "ë°±ì§€ì— ê³µì‹ ì ì–´ë³´ë©° ì•”ê¸° í™•ì¸",
                    "ì ‘ê·¼ë¶ˆê°€ ë¬¸ì œëŠ” í’€ì´ ì•”ê¸°í•˜ê¸°",
                    "ì‹¤ì „ì²˜ëŸ¼ ì‹œê°„ ì¬ë©° í’€ê¸°"
                ],
                "donts": [
                    "ìƒˆë¡œìš´ ê°œë… ê³µë¶€í•˜ì§€ ì•Šê¸°",
                    "ë„ˆë¬´ ì–´ë ¤ìš´ ë¬¸ì œì— ì‹œê°„ ë‚­ë¹„í•˜ì§€ ì•Šê¸°",
                    "ì˜¤ë‹µ ë…¸íŠ¸ ë„˜ê¸°ê¸°ë§Œ í•˜ì§€ ì•Šê¸°"
                ]
            })

        if days_until_exam >= 3:
            daily_plans.append({
                "day_label": "D-3",
                "focus": "ğŸ§˜ ë§ˆë¬´ë¦¬ ì •ë¦¬: ìì‹ ê° íšŒë³µ + ì»¨ë””ì…˜ ê´€ë¦¬",
                "activities": [
                    "ì˜¤ë‹µ ë…¸íŠ¸ ìµœì¢… ë³µìŠµ (ê°€ë³ê²Œ í›‘ê¸°)",
                    "ë°±ì§€ ë³µìŠµ ìµœì¢… (í•µì‹¬ ê³µì‹ 5-10ê°œ)",
                    "ì‰¬ìš´ ë¬¸ì œë¡œ ìì‹ ê° ìœ ì§€",
                    "8ì‹œê°„ ìˆ˜ë©´ í™•ë³´",
                    "ê°€ë²¼ìš´ ìš´ë™ìœ¼ë¡œ ì»¨ë””ì…˜ ê´€ë¦¬"
                ],
                "time_allocation": "í•˜ë£¨ 2ì‹œê°„ (ì˜¤ë‹µ 1h + ê³µì‹ 30m + ì‰¬ìš´ë¬¸ì œ 30m)",
                "dos": [
                    "ì•„ëŠ” ê²ƒ í™•ì¸í•˜ë©° ìì‹ ê° ì–»ê¸°",
                    "8ì‹œê°„ ì´ìƒ ìˆ˜ë©´í•˜ê¸°",
                    "ê°€ë²¼ìš´ ì‚°ì±…ì´ë‚˜ ìŠ¤íŠ¸ë ˆì¹­í•˜ê¸°"
                ],
                "donts": [
                    "âŒ ìƒˆë¡œìš´ ë¬¸ì œ í’€ì§€ ì•Šê¸°",
                    "âŒ ì–´ë ¤ìš´ ë¬¸ì œë¡œ ìì‹ ê° ê¹ì§€ ì•Šê¸°",
                    "âŒ ë°¤ëŠ¦ê²Œê¹Œì§€ ê³µë¶€í•˜ì§€ ì•Šê¸°"
                ]
            })

        daily_plans.append({
            "day_label": "D-1",
            "focus": "ğŸ˜´ íœ´ì‹ & ì ê²€: ì»¨ë””ì…˜ ìµœìƒìœ¼ë¡œ",
            "activities": [
                "ê°œë… ë…¸íŠ¸ ê°€ë³ê²Œ í›‘ê¸° (30ë¶„ ì´ë‚´)",
                "í•µì‹¬ ê³µì‹ 5ê°œë§Œ ìµœì¢… í™•ì¸",
                "ì‹œí—˜ ì¤€ë¹„ë¬¼ ì ê²€ (í•„ê¸°êµ¬, ì‹œê³„, ìˆ˜í—˜í‘œ)",
                "í‰ì†Œë³´ë‹¤ 1ì‹œê°„ ì¼ì° ì·¨ì¹¨ (22ì‹œ ì´ì „ ê¶Œì¥)",
                "ë‚´ì¼ ì‹œí—˜ì¥ ê°€ëŠ” ê¸¸ í™•ì¸"
            ],
            "time_allocation": "30ë¶„ ì´ë‚´ (ê·¸ ì´ìƒ ê³µë¶€ ê¸ˆì§€!)",
            "dos": [
                "ì•„ëŠ” ê²ƒë§Œ í™•ì¸í•˜ê¸°",
                "ì¼ì° ìê³  ì»¨ë””ì…˜ ìµœìƒìœ¼ë¡œ ë§Œë“¤ê¸°",
                "ì‹œí—˜ ì¤€ë¹„ë¬¼ ì „ë‚  ë°¤ì— ì±™ê¸°ê¸°"
            ],
            "donts": [
                "âŒ ìƒˆë¡œìš´ ë¬¸ì œ ì ˆëŒ€ í’€ì§€ ì•Šê¸°",
                "âŒ ë°¤ 11ì‹œ ë„˜ê²¨ì„œ ê³µë¶€í•˜ì§€ ì•Šê¸°",
                "âŒ ë¶ˆì•ˆí•˜ë‹¤ê³  ê³µë¶€ ë” í•˜ì§€ ì•Šê¸°"
            ]
        })

        daily_plans.append({
            "day_label": "D-day",
            "focus": "ğŸ’ª ì‹¤ì „ ëŒì…: í‰ìƒì‹¬ ìœ ì§€ + ì‹¤ë ¥ ë°œíœ˜",
            "activities": [
                "ê¸°ìƒ í›„ ê°€ë³ê²Œ ìŠ¤íŠ¸ë ˆì¹­",
                "ì•„ì¹¨ ì‹ì‚¬ ê¼­ í•˜ê¸° (ë‡Œì— í¬ë„ë‹¹ ê³µê¸‰)",
                "ì¶œë°œ ì „ í•µì‹¬ ê³µì‹ 5ê°œë§Œ í™•ì¸ (30ë¶„ ì´ë‚´)",
                "ì‹œí—˜ì¥ 30ë¶„ ì „ ë„ì°©",
                "ì‹œí—˜ ì§ì „ ì‹¬í˜¸í¡ 3íšŒ + 'í•  ìˆ˜ ìˆë‹¤' ìê¸°ì•”ì‹œ"
            ],
            "time_allocation": "ì•„ì¹¨ ê³µë¶€ 30ë¶„ ì´ë‚´",
            "dos": [
                "ìì‹ ê° ê°–ê³  ì¹¨ì°©í•˜ê²Œ ë¬¸ì œ ì½ê¸°",
                "ì‰¬ìš´ ë¬¸ì œë¶€í„° í’€ì–´ ë¦¬ë“¬ íƒ€ê¸°",
                "ë§ˆì§€ë§‰ 10ë¶„ì€ ê²€ì‚° ì‹œê°„ í™•ë³´"
            ],
            "donts": [
                "âŒ ì•„ì¹¨ì— ìƒˆë¡œìš´ ê²ƒ ê³µë¶€í•˜ì§€ ì•Šê¸°",
                "âŒ ì¹œêµ¬ë“¤ê³¼ ì–´ë ¤ìš´ ë¬¸ì œ í† ë¡ í•˜ì§€ ì•Šê¸°",
                "âŒ ì‹œí—˜ ëë‚˜ê³  ì •ë‹µ ë§ì¶°ë³´ì§€ ì•Šê¸°"
            ]
        })

        # ì„œìˆ í˜• ë¬¸í•­ ë¶„ì„
        essay_questions = [q for q in questions if q.get("question_format") == "essay"]
        essay_count = len(essay_questions)
        essay_points = sum(q.get("points", 0) or 0 for q in essay_questions)

        # ì‹œí—˜ ë‹¹ì¼ ì „ëµ
        during_exam_tips = [
            "ë¬¸ì œì§€ë¥¼ ë°›ìœ¼ë©´ ì „ì²´ë¥¼ í›‘ì–´ë³´ê¸°",
            "ì‰¬ìš´ ë¬¸ì œë¶€í„° í’€ì–´ì„œ ìì‹ ê° ì–»ê¸°",
            "ëª¨ë¥´ëŠ” ë¬¸ì œëŠ” í‘œì‹œí•˜ê³  ë„˜ì–´ê°€ê¸°",
            "ì‹œê°„ ë°°ë¶„ ì² ì €íˆ í•˜ê¸° (ë¬¸í•­ë‹¹ ì‹œê°„ ê³„ì‚°)",
            "ë§ˆì§€ë§‰ 10ë¶„ì€ ê²€ì‚° ì‹œê°„ìœ¼ë¡œ í™•ë³´",
            "ê³„ì‚° ì‹¤ìˆ˜ ë°©ì§€ ìœ„í•´ ê¼¼ê¼¼íˆ í™•ì¸"
        ]

        time_management_tips = [
            "ì „ì²´ ì‹œê°„ì˜ 80%ëŠ” ë¬¸ì œ í’€ì´, 20%ëŠ” ê²€ì‚°",
            "ì–´ë ¤ìš´ ë¬¸ì œì— ë„ˆë¬´ ì˜¤ë˜ ë§¤ë‹¬ë¦¬ì§€ ì•Šê¸°",
            "ì‹œê³„ë¥¼ ìì£¼ í™•ì¸í•˜ë©° ì§„í–‰"
        ]

        # ì„œìˆ í˜•ì´ ìˆëŠ” ê²½ìš° ì „ëµ ì¶”ê°€
        if essay_count > 0:
            avg_essay_points = essay_points / essay_count if essay_count > 0 else 0
            during_exam_tips.extend([
                f"ì„œìˆ í˜• {essay_count}ë¬¸í•­({round(essay_points)}ì )ì€ ê°ê´€ì‹ í›„ ì§‘ì¤‘ í’€ì´",
                "ì„œìˆ í˜• í’€ì´ ê³¼ì • ìƒëµ ê¸ˆì§€ - ë¶€ë¶„ì ìˆ˜ í™•ë³´ í•„ìˆ˜",
                "ì„œìˆ í˜• ë‹µì•ˆì€ ë…¼ë¦¬ì  íë¦„(â†’, â‡”) ëª…ì‹œí•˜ê¸°",
                "ì„œìˆ í˜• ìµœì¢… ë‹µì€ 'âˆ´ ë‹µ:' í˜•ì‹ìœ¼ë¡œ ëª…í™•íˆ í‘œê¸°"
            ])

            time_management_tips.extend([
                f"ì„œìˆ í˜• 1ë¬¸í•­ë‹¹ ìµœì†Œ {max(3, int(avg_essay_points / 2))}ë¶„ í• ë‹¹",
                "ì„œìˆ í˜• í’€ì´ í›„ ë°˜ë“œì‹œ ì¡°ê±´ ì¶©ì¡± ì—¬ë¶€ í™•ì¸"
            ])

        exam_day_strategy: ExamDayStrategyData = {
            "before_exam": [
                "ì¶©ë¶„í•œ ìˆ˜ë©´ìœ¼ë¡œ ì»¨ë””ì…˜ ìµœìƒìœ¼ë¡œ ë§Œë“¤ê¸°",
                "ì¤€ë¹„ë¬¼ ì²´í¬ (í•„ê¸°êµ¬, ìˆ˜í—˜í‘œ, ì‹œê³„)",
                "ê°€ë³ê²Œ ê³µì‹ ì•”ê¸° ë³µìŠµ (30ë¶„ ì´ë‚´)",
                "ì‹œí—˜ì¥ 30ë¶„ ì „ ë„ì°©"
            ],
            "during_exam": during_exam_tips,
            "time_management": time_management_tips,
            "stress_management": [
                "ì‹¬í˜¸í¡ìœ¼ë¡œ ê¸´ì¥ í’€ê¸°",
                "ë‚´ê°€ ì–´ë ¤ìš°ë©´ ë‚¨ë“¤ë„ ì–´ë µë‹¤ê³  ìƒê°í•˜ê¸°",
                "ë¬¸ì œ í•˜ë‚˜ì— ì§‘ì°©í•˜ì§€ ì•Šê¸°"
            ]
        }

        # ëª©í‘œ ì ìˆ˜ í–¥ìƒ
        if score_percentage >= 90:
            target_improvement = "ë§Œì  ë„ì „"
        elif score_percentage >= 80:
            target_improvement = "5-10ì  í–¥ìƒ"
        elif score_percentage >= 70:
            target_improvement = "10-15ì  í–¥ìƒ"
        elif score_percentage >= 60:
            target_improvement = "15-20ì  í–¥ìƒ"
        else:
            target_improvement = "20-30ì  í–¥ìƒ"

        # ë§ˆì§€ë§‰ ì¡°ì–¸
        if score_percentage >= 80:
            final_advice = f"ì´ë¯¸ ìš°ìˆ˜í•œ ì‹¤ë ¥ì„ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤. {days_until_exam}ì¼ ë™ì•ˆ ì‹¤ìˆ˜ë§Œ ì¤„ì´ë©´ ì¶©ë¶„íˆ ë§Œì ì— ê°€ê¹Œìš´ ì ìˆ˜ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìì‹ ê°ì„ ê°–ê³  ìµœì„ ì„ ë‹¤í•˜ì„¸ìš”!"
        elif score_percentage >= 60:
            final_advice = f"{days_until_exam}ì¼ì´ë©´ ì¶©ë¶„íˆ í–¥ìƒí•  ìˆ˜ ìˆëŠ” ì‹œê°„ì…ë‹ˆë‹¤. ì·¨ì•½ ë‹¨ì›ì— ì§‘ì¤‘í•˜ê³  ê¾¸ì¤€íˆ ë¬¸ì œë¥¼ í’€ë©´ ë°˜ë“œì‹œ ì¢‹ì€ ê²°ê³¼ê°€ ìˆì„ ê²ƒì…ë‹ˆë‹¤. í¬ê¸°í•˜ì§€ ë§ˆì„¸ìš”!"
        else:
            final_advice = f"ì§€ê¸ˆë¶€í„°ë¼ë„ ì—´ì‹¬íˆ í•˜ë©´ ë©ë‹ˆë‹¤. {days_until_exam}ì¼ ë™ì•ˆ ê¸°ë³¸ ê°œë…ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ë‹¤ì§€ì„¸ìš”. ì¡°ê¸ˆì”©ì´ë¼ë„ ë§¤ì¼ ê³µë¶€í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!"

        return {
            "exam_name": exam_name,
            "days_until_exam": days_until_exam,
            "target_score_improvement": target_improvement,
            "priority_areas": priority_areas,
            "daily_plans": daily_plans,
            "exam_day_strategy": exam_day_strategy,
            "final_advice": final_advice,
        }


# Singleton ì¸ìŠ¤í„´ìŠ¤
_exam_prep_strategy_agent = None


def get_exam_prep_strategy_agent() -> ExamPrepStrategyAgent:
    """ExamPrepStrategyAgent ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜"""
    global _exam_prep_strategy_agent
    if _exam_prep_strategy_agent is None:
        _exam_prep_strategy_agent = ExamPrepStrategyAgent()
    return _exam_prep_strategy_agent
