"""AI 문제 생성을 위한 교육과정 프롬프트 컨텍스트.

2022 개정 교육과정 기반, 학년별·개념별 핵심 지식을 구조화하여
Gemini 프롬프트에 주입한다.
"""

from typing import TypedDict


class ConceptPromptContext(TypedDict, total=False):
    """개념별 프롬프트 컨텍스트."""

    core_concepts: str  # 핵심 개념·공식
    misconceptions: str  # 주요 오개념
    design_guidelines: str  # 출제 포인트
    difficulty_guide: str  # 난이도별 기준 (선택)


# ─────────────────────────────────────────────
# 학년별 특성 (프롬프트 상단에 주입)
# ─────────────────────────────────────────────
GRADE_CONTEXT: dict[str, str] = {
    "elementary_3": (
        "초3: 자연수 연산 완성 + 분수·소수 첫 도입의 교차점. "
        "구체적 조작기 중반부로, 직관적 활동에서 형식적 알고리즘으로 전환하는 시기. "
        "분수 도입은 수포자 발생의 분수령. 개념적 이해(Conceptual Understanding) 평가 중시."
    ),
    "elementary_4": (
        "초4: 구체적 조작기→형식적 조작기 과도기. 추상화 수준 급상승. "
        "단순 연산 숙달→수학적 문해력과 개념적 이해 강조. "
        "도형의 포함 관계, 각도 개념, 큰 수의 자릿값 이해가 핵심."
    ),
    "elementary_5": (
        "초5: 수포자 대거 발생 시기. 자연수→유리수(분수, 소수) 확장. "
        "수학적 모델링과 과정 중심 평가 강조. "
        "약수·배수·통분은 이후 모든 분수 연산의 토대."
    ),
    "elementary_6": (
        "초6: 초등 수학의 완성 + 중등 수학의 기초. "
        "계산 숙달→연산의 의미 파악, 개념의 연결성·원리 이해 강조. "
        "비와 비율은 중등 함수·방정식의 기반."
    ),
    "middle_1": (
        "중1: 산술→대수 전환의 시작. 음수 도입, 문자와 식, 방정식. "
        "좌표평면과 비례 그래프로 함수 개념 첫 접근. "
        "기본 도형의 성질과 통계 기초."
    ),
    "middle_2": (
        "중2: 초등 직관→고등 형식적 수학의 교량. "
        "유리수 체계 완성, 대수적 유창성 확보, 논증 기하 시작. "
        "디지털 도구 활용 필수, 증명→정당화로 접근 장벽 완화."
    ),
    "middle_3": (
        "중3: 초·중등 수학의 완결점 + 고등 수학의 결정적 가교. "
        "유리수→실수 확장 완성. 이차식의 인수분해, 이차방정식, 이차함수가 대수의 정점. "
        "상자그림·산점도 신설/강화."
    ),
    "high_1": (
        "공통수학1(고1 1학기): 고교 수학 첫 관문. "
        "행렬 신설(AI 기초 소양), 경우의 수 1학기 이동. "
        "복잡한 문제 풀이 기술보다 구조 파악과 논리적 사고 중시."
    ),
}


# ─────────────────────────────────────────────
# 개념별 프롬프트 컨텍스트 (91개)
# ─────────────────────────────────────────────
PROMPT_CONTEXTS: dict[str, ConceptPromptContext] = {
    # ================================================================
    # 초등학교 3학년 (12개)
    # ================================================================
    "concept-e3-add-sub": {
        "core_concepts": (
            "• 세 자리 수의 덧셈과 뺄셈\n"
            "• 받아올림: 각 자리의 합이 10 이상일 때 상위 자릿수로 1 올림\n"
            "• 받아내림(재구조화): 상위 자리에서 1을 빌려 10으로 바꿈"
        ),
        "misconceptions": (
            "• 감산 방향성 오류: 423-157에서 일의 자리 3-7이 안 되니 7-3=4로 계산\n"
            "• 받아올림 누락: 십의 자리 합이 12인데 백의 자리로 1 안 올림\n"
            "• 자릿수 정렬 오류: 가로셈→세로셈 변환 시 왼쪽 정렬"
        ),
        "design_guidelines": (
            "• 받아내림의 필요성 인식 문항 출제\n"
            "• 오류 찾기(Error Analysis) 유형 적극 활용\n"
            "• 중간 계산 과정 빈칸으로 받아올림 표기 강제"
        ),
    },
    "concept-e3-plane": {
        "core_concepts": (
            "• 선분: 두 점을 잇는 가장 짧은 선 (길이 유한)\n"
            "• 반직선: 한 점에서 시작해 한쪽으로 끝없이 뻗은 선\n"
            "• 직선: 양쪽으로 끝없이 뻗은 선\n"
            "• 각: 한 점에서 그은 두 반직선, 직각: 종이를 두 번 접은 각"
        ),
        "misconceptions": (
            "• 반직선 AB = 반직선 BA라고 착각 (시작점+방향 모두 같아야 동일)\n"
            "• 직각의 방향성 고착: 기울어진 직각 못 찾음\n"
            "• 변 길이 = 각 크기 혼동: 변이 길면 각도 크다고 착각"
        ),
        "design_guidelines": (
            "• 다양한 각도로 회전된 도형에서 직각 모두 찾기\n"
            "• 반직선 AB와 BA를 구별하는 문항\n"
            "• 변의 길이는 다르지만 각의 크기는 같은 두 각 비교"
        ),
    },
    "concept-e3-div1": {
        "core_concepts": (
            "• 등분제: 전체를 똑같은 수의 묶음으로 나눌 때 한 묶음의 개수\n"
            "• 포함제: 전체를 한 묶음씩 덜어낼 때 묶음의 개수\n"
            "• 곱셈과의 관계: 12÷3=4 ↔ 3×4=12"
        ),
        "misconceptions": (
            "• 교환법칙 적용 오류: 12÷4와 4÷12를 같다고 착각\n"
            "• 몫의 의미 혼동: 등분제/포함제 상황 구별 못함"
        ),
        "design_guidelines": (
            "• 구체물 그림 제시→상황에 맞는 나눗셈식 고르기\n"
            "• 관계 짓기: 곱셈식 2개, 나눗셈식 2개 만들기"
        ),
    },
    "concept-e3-mul1": {
        "core_concepts": (
            "• (몇십몇)×(몇) 계산 원리\n"
            "• 분배법칙의 기초: 23×2 = 20×2 + 3×2\n"
            "• 올림이 있는 곱셈"
        ),
        "misconceptions": (
            "• 자릿수 혼동: 23×4에서 3×4=12, 2×4=8을 나열해 812로 표기\n"
            "• 십의 자리 '2'가 실제로는 '20'임을 간과"
        ),
        "design_guidelines": (
            "• 모눈종이(Area Model) 활용 문항\n"
            "• 20×4 영역과 3×4 영역 구분하여 합산"
        ),
    },
    "concept-e3-length-time": {
        "core_concepts": (
            "• 길이 단위: 1mm, 1cm, 1m, 1km 변환\n"
            "• 시각과 시간(양) 구별, 초 단위까지 읽기\n"
            "• 시간의 덧셈과 뺄셈"
        ),
        "misconceptions": (
            "• 60진법과 10진법 충돌: 1시간 40분+30분=1시간 70분=1.7시간으로 계산\n"
            "• 자 눈금 읽기: 항상 0에서 시작해야 한다고 착각"
        ),
        "design_guidelines": (
            "• 부러진 자 문제: 0 눈금 없는 자에서 물체 길이 구하기\n"
            "• 시간 덧셈에서 받아올림 기준(60) 강조"
        ),
    },
    "concept-e3-frac-dec": {
        "core_concepts": (
            "• 분수의 정의: 전체를 '똑같이' 나눈 것 중 일부\n"
            "• 단위분수: 분자가 1인 분수\n"
            "• 소수 도입: 1/10 = 0.1\n"
            "• 크기 비교: 분모가 같은 분수, 단위분수, 소수"
        ),
        "misconceptions": (
            "• '똑같이 나누기' 실패: 크기 다른 4조각 중 1개를 1/4이라 함\n"
            "• 단위분수의 역설: 1/3 > 1/2라고 착각 (3이 2보다 크니까)\n"
            "• 소수 0.1의 실체성 부재: 0보다 작은 수로 오해"
        ),
        "design_guidelines": (
            "• 등분된 것과 안 된 것 섞어서 1/4을 나타내는 그림 모두 고르기\n"
            "• 수직선 위에서 0과 1 사이를 10칸으로 나누고 소수 위치 찍기"
        ),
    },
    "concept-e3-mul2": {
        "core_concepts": (
            "• (세 자리 수)×(한 자리 수)\n"
            "• (두 자리 수)×(두 자리 수): 4번의 부분 곱 합산\n"
            "• 초등 연산 중 가장 복잡한 알고리즘"
        ),
        "misconceptions": (
            "• 자릿수 맞춤 오류: 34×12에서 34×10=340인데 0 생략하고 34로 적음\n"
            "• 34×2+34×1로 잘못 계산"
        ),
        "design_guidelines": (
            "• 계산 과정에서 0을 쓰도록 칸 제공\n"
            "• 자릿수 개념 강화 문항"
        ),
    },
    "concept-e3-div2": {
        "core_concepts": (
            "• 나머지가 있는 나눗셈\n"
            "• 검산: A÷B=Q...R → A=B×Q+R\n"
            "• 나머지 < 나누는 수 (R < B)"
        ),
        "misconceptions": (
            "• 나머지 크기 조건 위반: 14÷3=3...5라고 씀\n"
            "• 문맥적 해석 실패: 올림 상황 vs 버림 상황 구별 못함"
        ),
        "design_guidelines": (
            "• 잘못된 계산 제시→나머지 성질로 틀린 이유 설명\n"
            "• 올림 상황 vs 버림 상황 구별 문항"
        ),
    },
    "concept-e3-circle": {
        "core_concepts": (
            "• 원의 중심: 원 그릴 때 고정된 점\n"
            "• 반지름: 중심에서 원 위의 한 점까지 (한 원에서 모두 같음)\n"
            "• 지름: 원 위의 두 점을 잇는 선분 중 중심을 지나는 선분\n"
            "• 지름 = 반지름 × 2"
        ),
        "misconceptions": (
            "• 반지름 방향 가변성 오해: 위쪽/옆쪽 반지름 길이가 다르다고 착각\n"
            "• 지름 정의 오류: 원 내부를 지나는 아무 선분(현)을 지름이라 부름"
        ),
        "design_guidelines": (
            "• 원 안에 여러 선분 그려놓고 지름인 것/아닌 것 분류\n"
            "• 기준: 원의 중심을 지나는가?"
        ),
    },
    "concept-e3-volume-weight": {
        "core_concepts": (
            "• 들이 단위: L, mL (1L=1000mL)\n"
            "• 무게 단위: kg, g (1kg=1000g)\n"
            "• 같은 단위끼리 덧셈과 뺄셈"
        ),
        "misconceptions": (
            "• 부피=무게 혼동: 부피가 크면 무조건 더 무겁다고 착각\n"
            "• 단위 변환 오류: 1000 관계 혼동"
        ),
        "design_guidelines": (
            "• 시각적 부피와 실제 무게가 상충하는 상황 제시\n"
            "• 단위 변환 문제"
        ),
    },
    "concept-e3-frac2": {
        "core_concepts": (
            "• 진분수: 분자 < 분모\n"
            "• 가분수: 분자 ≥ 분모\n"
            "• 대분수: 자연수 + 진분수\n"
            "• 분모가 같은 분수의 덧셈과 뺄셈: 분모 그대로, 분자끼리 연산"
        ),
        "misconceptions": (
            "• 분모 덧셈 오류: 2/7+3/7=5/14 (분모와 분자 각각 더함)\n"
            "• 대분수↔가분수 변환 오류"
        ),
        "design_guidelines": (
            "• 파이 차트로 분수 덧셈 시각적 증명\n"
            "• 조각의 크기(분모)는 불변, 개수(분자)만 증가"
        ),
    },
    "concept-e3-data": {
        "core_concepts": (
            "• 자료 수집→표 정리→그림그래프(Picture Graph) 표현\n"
            "• 단위 설정: 그림 하나가 나타내는 수 (10, 100 등)"
        ),
        "misconceptions": (
            "• 상징의 수량화 실패: 큰 스마일=10명인데 그림 3개를 보고 3명이라 답함\n"
            "• 범례 무시하고 그림 개수만 셈"
        ),
        "design_guidelines": (
            "• 범례 다양하게 변형 (큰 그림=100, 작은 그림=10)\n"
            "• 그림 개수 ≠ 실제 수량임을 계산하는 문제"
        ),
    },

    # ================================================================
    # 초등학교 4학년 (12개)
    # ================================================================
    "concept-e4-big-num": {
        "core_concepts": (
            "• 10배의 원리 (자릿수가 왼쪽으로 한 칸→10배)\n"
            "• 4자리씩 끊어 읽기 (만, 억, 조)\n"
            "• 수의 크기 비교: 자릿수→최상위 자릿수부터 비교"
        ),
        "misconceptions": (
            "• 0이 포함된 수에서 빈 자리 누락 (삼억 오천만→35000)\n"
            "• 자릿값과 자릿수 혼동 (5가 나타내는 값 ≠ 숫자 5)\n"
            "• 큰 수의 양감 부족"
        ),
        "design_guidelines": (
            "• 연속된 0이 있는 수의 받아쓰기\n"
            "• 실생활 데이터(국가 예산, 인구) 연결"
        ),
    },
    "concept-e4-angle": {
        "core_concepts": (
            "• 각의 크기 = 두 변이 벌어진 정도 (변의 길이와 무관)\n"
            "• 분류: 예각(0°~90°), 직각(90°), 둔각(90°~180°)\n"
            "• 삼각형 내각의 합=180°, 사각형=360°"
        ),
        "misconceptions": (
            "• 변이 길면 각도 크다고 착각\n"
            "• 각도기 안쪽/바깥쪽 눈금 혼동 (둔각을 60°로 읽음)\n"
            "• 삼각형 모양 달라지면 내각의 합도 변한다고 오해"
        ),
        "design_guidelines": (
            "• 변의 길이는 다르나 각이 같은 도형 비교\n"
            "• 다양한 삼각형의 내각의 합 확인 문제"
        ),
    },
    "concept-e4-mul-div": {
        "core_concepts": (
            "• (세 자리 수)×(두 자리 수) 알고리즘\n"
            "• (세 자리 수)÷(두 자리 수): 가늠→곱하기→빼기→확인\n"
            "• 검산: 나누는 수 × 몫 + 나머지 = 나누어지는 수"
        ),
        "misconceptions": (
            "• 곱셈 세로셈에서 자릿수 맞추기 오류\n"
            "• 나눗셈 몫 가늠하기 어려움\n"
            "• 나머지의 맥락적 해석 실패 (올림/버림 판단)"
        ),
        "design_guidelines": (
            "• 몫의 범위 어림하기 문항\n"
            "• 잘못된 계산 과정에서 오류 찾기\n"
            "• 실생활 문장제에서 나머지 처리 판단"
        ),
    },
    "concept-e4-transform": {
        "core_concepts": (
            "• 밀기: 위치만 변화, 모양·크기·방향 불변\n"
            "• 뒤집기: 대칭축 기준 좌우/상하 반전\n"
            "• 돌리기: 중심점 기준 90°, 180°, 270° 회전"
        ),
        "misconceptions": (
            "• 오른쪽 뒤집기↔시계방향 180° 돌리기 혼동\n"
            "• 시계/반시계 방향 혼동\n"
            "• 90° 돌리기↔270° 돌리기 결과 착각"
        ),
        "design_guidelines": (
            "• 비대칭 도형(ㄱ, ㄴ, P 등) 활용 필수\n"
            "• 뒤집기+돌리기 복합 적용 문제"
        ),
    },
    "concept-e4-bar-graph": {
        "core_concepts": (
            "• 구성 요소: 가로축, 세로축, 눈금, 막대, 제목\n"
            "• 눈금 한 칸의 크기 결정\n"
            "• 항목 간 대소 비교, 경향성 파악"
        ),
        "misconceptions": (
            "• 눈금 한 칸을 무조건 1로 설정\n"
            "• 눈금선 중간값 읽기 어려움"
        ),
        "design_guidelines": (
            "• 적절한 눈금 크기 결정하기\n"
            "• 중간값 어림하여 읽기"
        ),
    },
    "concept-e4-pattern": {
        "core_concepts": (
            "• 수/도형 배열 규칙 (덧셈, 곱셈, 뺄셈, 나눗셈)\n"
            "• 계산식의 패턴 발견\n"
            "• 규칙을 수학적 언어로 표현"
        ),
        "misconceptions": (
            "• 표면적 패턴만 인식 (2,4,6...→+2로 단정, ×2 가능성 무시)\n"
            "• 도형 패턴을 수로 변환하지 못함"
        ),
        "design_guidelines": (
            "• 복잡한 단계(10번째 도형의 개수) 문제\n"
            "• 계산식에서 규칙 변화 설명하기"
        ),
    },
    "concept-e4-frac-op": {
        "core_concepts": (
            "• 분모가 같은 분수: 분모 그대로, 분자끼리 연산\n"
            "• 대분수 덧셈: 자연수끼리+분수끼리 (또는 가분수로 변환)\n"
            "• 대분수 뺄셈 받아내림: 자연수에서 1 빌려와 가분수로 변환"
        ),
        "misconceptions": (
            "• 분모끼리 더하기: ⅓+⅓=2/6\n"
            "• 자연수-분수 계산 오류 (3-⅖ 처리 못함)\n"
            "• 받아내림 시 분자에 10 더함 (분모만큼 더해야 함)"
        ),
        "design_guidelines": (
            "• 파이, 막대 등 그림 모델과 식 연결\n"
            "• 재그룹화 과정 시각화"
        ),
    },
    "concept-e4-triangle": {
        "core_concepts": (
            "• 이등변삼각형: 두 변 같음, 두 밑각 같음\n"
            "• 정삼각형: 세 변 같음, 세 각 모두 60°\n"
            "• 각에 따른 분류: 예각/직각/둔각삼각형\n"
            "• 포함 관계: 정삼각형 ⊂ 이등변삼각형"
        ),
        "misconceptions": (
            "• 예각이 하나만 있어도 예각삼각형이라 착각\n"
            "• 회전된 이등변삼각형 인식 못함\n"
            "• 정삼각형은 이등변삼각형이 아니라고 오답"
        ),
        "design_guidelines": (
            "• 둔각삼각형에서 예각 찾기\n"
            "• 포함 관계 확인 문제\n"
            "• 다양한 방향의 도형 제시"
        ),
    },
    "concept-e4-dec-op": {
        "core_concepts": (
            "• 0.01, 0.001의 의미\n"
            "• 소수점 앞부터 차례로 크기 비교\n"
            "• 소수점 위치 맞추어 세로로 정렬"
        ),
        "misconceptions": (
            "• 소수가 길면 크다고 착각 (0.125 > 0.5 오류)\n"
            "• 자릿수 정렬 오류 (2.5+12에서 5와 2를 더함)\n"
            "• 3.5=3.50 이해 못함"
        ),
        "design_guidelines": (
            "• 자릿값 판(Place Value Chart) 활용\n"
            "• 소수점 기준 정렬 강조"
        ),
    },
    "concept-e4-quad": {
        "core_concepts": (
            "• 수직: 두 직선이 만나 직각 형성\n"
            "• 평행: 두 직선이 만나지 않음\n"
            "• 분류: 사다리꼴→평행사변형→마름모/직사각형→정사각형"
        ),
        "misconceptions": (
            "• 포함 관계 이해 부족: 정사각형은 직사각형인가?→예\n"
            "• 마름모를 다이아몬드 형태로만 인식\n"
            "• 평행선 사이 거리를 비스듬히 잼"
        ),
        "design_guidelines": (
            "• 벤다이어그램으로 포함 관계 평가\n"
            "• 평행사변형을 모두 고르시오에 직사각형·정사각형 포함\n"
            "• 다양한 방향의 마름모 제시"
        ),
    },
    "concept-e4-line-graph": {
        "core_concepts": (
            "• 연속적 변량(시간에 따른 변화) 시각화\n"
            "• 선분 방향으로 증가/감소 판단, 기울기로 변화 크기 판단\n"
            "• 물결선: 불필요한 구간 생략"
        ),
        "misconceptions": (
            "• 항목별 비교에도 꺾은선그래프 사용 (막대그래프가 적합)\n"
            "• 미래 예측 시 추세 반영 못함"
        ),
        "design_guidelines": (
            "• 자료 성격에 따른 그래프 선택 문제\n"
            "• 추세 기반 합리적 추론"
        ),
    },
    "concept-e4-polygon": {
        "core_concepts": (
            "• 다각형: 선분으로만 둘러싸인 닫힌 도형\n"
            "• 정다각형: 변의 길이 모두 같음 + 각의 크기 모두 같음 (두 조건 필수)\n"
            "• 대각선: 이웃하지 않는 두 꼭짓점 연결"
        ),
        "misconceptions": (
            "• 변만 같으면 정다각형 (마름모 반례)\n"
            "• 각만 같으면 정다각형 (직사각형 반례)\n"
            "• 삼각형에 대각선이 없다는 사실 간과"
        ),
        "design_guidelines": (
            "• 마름모 제시 후 정다각형인가? 질문\n"
            "• 두 조건의 필요충분성 확인 문제"
        ),
    },

    # ================================================================
    # 초등학교 5학년 (12개)
    # ================================================================
    "concept-e5-mixed-calc": {
        "core_concepts": (
            "• 연산의 우선순위: 괄호→곱셈·나눗셈→덧셈·뺄셈\n"
            "• 동순위는 왼쪽→오른쪽\n"
            "• 문장제를 하나의 식으로 표현 (모델링)"
        ),
        "misconceptions": (
            "• 선형적 계산 오류: 20-5×2=15×2=30 (위계 무시)\n"
            "• 괄호 무용론: 괄호 있어도/없어도 같다고 생각\n"
            "• 역연산 논리 결함"
        ),
        "design_guidelines": (
            "• '계산하시오' 지양→'계산 순서를 표시하시오'\n"
            "• 괄호 위치만 바꿨을 때 결과 비교 문항"
        ),
    },
    "concept-e5-divisor": {
        "core_concepts": (
            "• 약수·배수 정의: A=B×C일 때 B,C는 A의 약수, A는 B,C의 배수\n"
            "• 최대공약수(GCD): 공약수 중 가장 큰 수\n"
            "• 최소공배수(LCM): 공배수 중 가장 작은 수\n"
            "• 관계식: (두 수의 곱) = GCD × LCM"
        ),
        "misconceptions": (
            "• 약수 누락: 1과 자기 자신 빠뜨림\n"
            "• 배수의 유한성 착각: 배수는 무한함\n"
            "• 최대공배수/최소공약수 오류: 존재하지 않는 개념"
        ),
        "design_guidelines": (
            "• 정의 기반 발문: '12를 나누어떨어지게 하는 수를 모두 찾으시오'\n"
            "• 곱과 GCD만 알 때 LCM 구하기"
        ),
    },
    "concept-e5-correspondence": {
        "core_concepts": (
            "• 두 양 사이의 관계: 독립변수·종속변수 식별\n"
            "• 대응 관계 표현: 말→표→기호(□,△)를 사용한 식\n"
            "• 식의 의미 해석"
        ),
        "misconceptions": (
            "• 덧셈 규칙↔곱셈 규칙 혼동: y=x+3(차이 일정) vs y=3x(비율 일정)\n"
            "• 기호 정의 부재: □,△가 뭔지 정의 안 하고 식만 씀"
        ),
        "design_guidelines": (
            "• 표의 일부 지워진 상태에서 규칙 유추→빈칸 채우기\n"
            "• 역방향 문제: 식을 만족하는 실생활 상황 만들기"
        ),
    },
    "concept-e5-reduce": {
        "core_concepts": (
            "• 분수의 기본 성질: 분모·분자에 0 아닌 같은 수를 곱/나눠도 크기 불변\n"
            "• 약분: 공약수로 나눠 간단히, 기약분수까지\n"
            "• 통분: 분모를 같게 만들기 (공통분모)"
        ),
        "misconceptions": (
            "• 약분 불완전: 2로 한 번 나누고 멈춤\n"
            "• 통분 시 분자 연산 누락: 분모만 바꾸고 분자는 그대로\n"
            "• 크기 비교 직관 오류: 분모·분자 숫자가 크면 큰 수라고 착각"
        ),
        "design_guidelines": (
            "• 통분 과정에서 분자 변환 확인\n"
            "• 기약분수 여부 판별 문제"
        ),
    },
    "concept-e5-frac-add": {
        "core_concepts": (
            "• 이종 분모 연산: 분모가 다르면 단위가 다름→통분으로 단위 일치\n"
            "• 대분수 연산: 자연수끼리+분수끼리 또는 가분수 변환\n"
            "• 받아올림/받아내림"
        ),
        "misconceptions": (
            "• 분모끼리/분자끼리 덧셈: ½+⅓=2/5 (가장 치명적인 오개념)\n"
            "• 받아내림 시 십진법 혼동: 분자에 10 더함 (분모만큼 더해야 함)"
        ),
        "design_guidelines": (
            "• 피자 조각으로 ½+⅓≠2/5 시각적 증명\n"
            "• 오류 찾기(Error Correction) 문항"
        ),
    },
    "concept-e5-polygon-area": {
        "core_concepts": (
            "• 평행사변형: 밑변×높이\n"
            "• 삼각형: 밑변×높이÷2\n"
            "• 마름모: 한 대각선×다른 대각선÷2\n"
            "• 사다리꼴: (윗변+아랫변)×높이÷2\n"
            "• 둘레↔넓이 독립성"
        ),
        "misconceptions": (
            "• ÷2 누락: 삼각형, 마름모, 사다리꼴\n"
            "• 높이 오인: 빗변 길이를 높이로 착각 (높이=밑변과 수직인 거리)\n"
            "• 직사각형 편향: 모든 사각형을 가로×세로로 계산"
        ),
        "design_guidelines": (
            "• 밑변·빗변만 주고 높이 안 주는 함정 문제\n"
            "• 넓이 공식을 평행사변형으로 설명하시오 서술형"
        ),
    },
    "concept-e5-range-rounding": {
        "core_concepts": (
            "• 이상(≥), 이하(≤): 기준수 포함 / 초과(>), 미만(<): 기준수 미포함\n"
            "• 올림: 부족하면 안 되는 상황, 버림: 넘치면 안 되는 상황\n"
            "• 반올림: 0~4 버림, 5~9 올림"
        ),
        "misconceptions": (
            "• 경계값 포함 여부 혼동: 50 이상에 50 포함 여부\n"
            "• '~에서 반올림'↔'~까지 나타내시오' 자릿수 혼동"
        ),
        "design_guidelines": (
            "• 상황 판단: 올림/버림/반올림 중 적절한 것 선택\n"
            "• 수직선에 범위 정확히 작도"
        ),
    },
    "concept-e5-frac-mul": {
        "core_concepts": (
            "• 연산자로서의 분수: 6×⅓=6을 3등분 한 것 중 1\n"
            "• 면적 모델: 진분수×진분수=가로·세로 쪼개어 겹치는 부분\n"
            "• 약분의 효율성: 대각선 방향으로 미리 약분"
        ),
        "misconceptions": (
            "• 대분수 곱셈 오류: 1½×1½에서 자연수끼리·분수끼리 따로 곱함\n"
            "• 축소 변환 불신: 진분수 곱하면 작아지는 것을 의심"
        ),
        "design_guidelines": (
            "• 면적 모델로 진분수×진분수 시각화\n"
            "• 대분수 곱셈→가분수 변환 필수 강조"
        ),
    },
    "concept-e5-congruence": {
        "core_concepts": (
            "• 합동: 모양과 크기가 같아 포개면 완전히 겹침\n"
            "• 대응점, 대응변, 대응각\n"
            "• 선대칭도형: 대칭축을 따라 접으면 겹침\n"
            "• 점대칭도형: 대칭의 중심 기준 180° 돌리면 겹침"
        ),
        "misconceptions": (
            "• 뒤집히거나 회전된 도형을 합동 아니라고 착각\n"
            "• 평행사변형의 대각선을 대칭축으로 착각 (선대칭 아님)\n"
            "• 직사각형 대칭축=대각선(×), 각 변의 중점 연결(○)"
        ),
        "design_guidelines": (
            "• 선대칭도형의 대칭축을 잘못 그린 것 고르기 (평행사변형 함정)\n"
            "• 도형 일부만 주고 대칭 성질로 완성하기"
        ),
    },
    "concept-e5-dec-mul": {
        "core_concepts": (
            "• 소수점 이동 원리: 곱하는 수가 1/10배→적의 소수점 왼쪽\n"
            "• 계산 알고리즘: 자연수처럼 계산 후, 소수점 아래 자릿수 합만큼 소수점 찍기"
        ),
        "misconceptions": (
            "• 소수점 위치 오류(0 처리): 0.5×0.4에서 0 먼저 지우고 소수점→0.02 오류\n"
            "• 어림 부재: 4.1×5.2≈20인데 213.2나 2.132라 답함"
        ),
        "design_guidelines": (
            "• 계산 전 어림(Estimation)으로 결과 범위 예측\n"
            "• 소수점 위치 확인 문제"
        ),
    },
    "concept-e5-cuboid": {
        "core_concepts": (
            "• 직육면체: 직사각형 6개로 둘러싸인 도형\n"
            "• 정육면체: 정사각형 6개로 둘러싸인 도형\n"
            "• 겨냥도와 전개도: 보이지 않는 모서리=점선"
        ),
        "misconceptions": (
            "• 밑면 고정 관념: 밑에 있는 면만 밑면이라 생각\n"
            "• 전개도 접기 실패: 멀리 떨어진 선분이 접으면 만나는지 파악 못함"
        ),
        "design_guidelines": (
            "• 전개도에 무늬→접었을 때 올바른 겨냥도 고르기\n"
            "• 주사위 전개도: 마주 보는 면 찾기"
        ),
    },
    "concept-e5-average": {
        "core_concepts": (
            "• 평균의 의미: 자료를 고르게 하여 전체 대표 (평탄화)\n"
            "• 가능성: 불가능~확실을 0, ½, 1 등 수치로 대응"
        ),
        "misconceptions": (
            "• 평균의 대표성 오해: 평균 80점이면 모든 과목 80점 근처라 착각\n"
            "• 0의 처리: 0점인 과목도 자료의 수에 포함\n"
            "• 가능성의 주관적 해석"
        ),
        "design_guidelines": (
            "• 극단값이 평균에 미치는 영향 문제\n"
            "• 0이 포함된 자료의 평균 계산"
        ),
    },

    # ================================================================
    # 초등학교 6학년 (12개)
    # ================================================================
    "concept-e6-frac-div1": {
        "core_concepts": (
            "• 나눗셈의 몫을 분수로: a÷b=a/b\n"
            "• (분수)÷(자연수): a/b÷c = a/b×1/c\n"
            "• 나눗셈 기호(÷)와 분수 막대의 동일한 의미"
        ),
        "misconceptions": (
            "• '나눗셈 하면 숫자가 작아진다' (자연수 경험칙에 갇힘)\n"
            "• 교환법칙 오류: 작은 수÷큰 수에서 순서 뒤바꿈"
        ),
        "design_guidelines": (
            "• 숫자 크기만 보고 식 세우면 틀리는 문항\n"
            "• 넓이 모델로 원리 설명하기"
        ),
    },
    "concept-e6-prism-pyramid": {
        "core_concepts": (
            "• 분류 기준: 밑면의 모양에 따라 이름 결정\n"
            "• 구성 요소: 밑면, 옆면, 모서리, 꼭짓점, 높이\n"
            "• 각기둥 높이: 두 밑면 사이의 거리\n"
            "• 각뿔 높이: 꼭짓점에서 밑면에 내린 수선의 길이"
        ),
        "misconceptions": (
            "• '밑면=바닥에 있는 면' (회전/눕힌 도형에서 오류)\n"
            "• 각뿔의 높이↔모선(옆 모서리) 길이 혼동"
        ),
        "design_guidelines": (
            "• 옆으로 누운 삼각기둥에서 밑면/높이 찾기\n"
            "• 전개도에서 구성 요소 직접 세기"
        ),
    },
    "concept-e6-dec-div1": {
        "core_concepts": (
            "• 자연수 나눗셈과의 연결: 24.8÷4는 248÷4의 1/10배\n"
            "• 몫의 소수점 위치: 피제수의 소수점 위치를 그대로 올려 찍기"
        ),
        "misconceptions": (
            "• 몫의 중간 0 누락: 6.12÷3=2.4 (정답: 2.04)\n"
            "• 나머지 해석 오류"
        ),
        "design_guidelines": (
            "• 몫의 중간에 0이 들어가는 문항 필수\n"
            "• 자릿값 개념 테스트"
        ),
    },
    "concept-e6-ratio": {
        "core_concepts": (
            "• 비의 구조: a:b에서 a=비교하는 양, b=기준량\n"
            "• 비율: 비교하는 양/기준량→분수/소수\n"
            "• 백분율: 기준량을 100으로 환산한 비율"
        ),
        "misconceptions": (
            "• 기준량 찾기 실패: '~에 대한'이 붙은 대상이 기준량\n"
            "• 농도 문제에서 분모를 '물'로 잡음 (전체=소금+물)\n"
            "• 문장 어순과 비의 순서 혼동"
        ),
        "design_guidelines": (
            "• 문장 어순과 비 순서가 반대인 문제\n"
            "• 소금물 농도 함정 문제"
        ),
    },
    "concept-e6-graphs": {
        "core_concepts": (
            "• 띠그래프: 전체에 대한 각 부분의 비율\n"
            "• 원그래프: 360° 또는 100%로 비율 표현\n"
            "• 그래프 해석: 비율 비교, 경향성 파악"
        ),
        "misconceptions": (
            "• 비율과 실제 양 혼동: 비율이 크면 양도 크다고 착각\n"
            "• 전체가 다른 그래프 비교 시 오류"
        ),
        "design_guidelines": (
            "• 전체가 다른 두 그래프 비교 문제\n"
            "• 적절한 그래프 유형 선택"
        ),
    },
    "concept-e6-volume": {
        "core_concepts": (
            "• 부피 단위: 1cm³, 1m³\n"
            "• 직육면체 부피: 가로×세로×높이\n"
            "• 겉넓이: 6개 면의 넓이 합"
        ),
        "misconceptions": (
            "• 부피와 겉넓이 공식 혼동\n"
            "• 단위 변환 오류: 1m³=1,000,000cm³"
        ),
        "design_guidelines": (
            "• 쌓기나무로 부피 세기\n"
            "• 부피는 같으나 겉넓이가 다른 도형 비교"
        ),
    },
    "concept-e6-frac-div2": {
        "core_concepts": (
            "• (분수)÷(분수): 나누는 수의 역수를 곱함\n"
            "• 역수: a/b의 역수는 b/a\n"
            "• 나눗셈→곱셈 변환 원리"
        ),
        "misconceptions": (
            "• 역수 적용 오류: 나누어지는 수를 뒤집음\n"
            "• 대분수 나눗셈에서 가분수 변환 안 함"
        ),
        "design_guidelines": (
            "• 역수를 곱하는 이유 설명 문항\n"
            "• 그림 모델로 분수 나눗셈 시각화"
        ),
    },
    "concept-e6-dec-div2": {
        "core_concepts": (
            "• (소수)÷(소수): 나누는 수를 자연수로 만들기 위해 양쪽 소수점 이동\n"
            "• 소수점 이동 원리: 10배, 100배"
        ),
        "misconceptions": (
            "• 한쪽만 소수점 이동\n"
            "• 이동 후 나머지 소수점 위치 혼동"
        ),
        "design_guidelines": (
            "• 소수점 이동 전후 비교 문항\n"
            "• 자연수÷소수도 포함"
        ),
    },
    "concept-e6-spatial": {
        "core_concepts": (
            "• 쌓기나무: 위, 앞, 옆에서 본 모양\n"
            "• 공간 감각: 3차원→2차원 변환, 2차원→3차원 추론"
        ),
        "misconceptions": (
            "• 숨겨진 쌓기나무 개수 파악 못함\n"
            "• 보는 방향에 따른 모양 변화 이해 부족"
        ),
        "design_guidelines": (
            "• 세 방향 그림 주고 쌓기나무 최소/최대 개수 구하기\n"
            "• 하나의 입체→세 방향 그림 그리기"
        ),
    },
    "concept-e6-proportion": {
        "core_concepts": (
            "• 비례식: a:b=c:d → 외항의 곱=내항의 곱 (ad=bc)\n"
            "• 비례배분: 전체를 주어진 비로 나누기"
        ),
        "misconceptions": (
            "• 외항/내항 혼동\n"
            "• 비례배분에서 비의 합으로 나누는 것 잊음"
        ),
        "design_guidelines": (
            "• 미지수가 포함된 비례식 풀기\n"
            "• 실생활 비례배분 문제"
        ),
    },
    "concept-e6-circle-area": {
        "core_concepts": (
            "• 원주율(π): 지름에 대한 원주의 비율 (약 3.14)\n"
            "• 원의 둘레: 지름×π (또는 2×반지름×π)\n"
            "• 원의 넓이: 반지름×반지름×π"
        ),
        "misconceptions": (
            "• 둘레와 넓이 공식 혼동\n"
            "• π를 정확한 수로 착각 (무한소수)\n"
            "• 반지름과 지름 혼동"
        ),
        "design_guidelines": (
            "• 원 쪼개어 직사각형으로 만들기→넓이 공식 유도\n"
            "• 반원, 부채꼴 넓이 응용"
        ),
    },
    "concept-e6-solids": {
        "core_concepts": (
            "• 원기둥: 합동인 두 원(밑면), 전개도의 옆면은 직사각형\n"
            "• 원뿔: 밑면 원 1개, 꼭짓점 1개, 모선\n"
            "• 구: 중심에서 같은 거리인 점들의 집합"
        ),
        "misconceptions": (
            "• 원기둥 옆면 전개도가 직사각형인 것 이해 못함\n"
            "• 원뿔의 높이와 모선 혼동"
        ),
        "design_guidelines": (
            "• 전개도로 원기둥 겉넓이 구하기\n"
            "• 회전체 만들기: 직사각형 회전→원기둥"
        ),
    },

    # ================================================================
    # 중학교 1학년 (12개)
    # ================================================================
    "concept-m1-prime": {
        "core_concepts": (
            "• 소수: 1보다 크고 1과 자신만을 약수로 가지는 자연수\n"
            "• 소인수분해: 자연수를 소수의 곱으로 표현\n"
            "• 약수의 개수: 각 소인수 지수+1의 곱\n"
            "• 최대공약수: 공통 소인수의 최소 지수 곱, 최소공배수: 최대 지수 곱"
        ),
        "misconceptions": (
            "• 1을 소수로 착각\n"
            "• 소인수분해가 완전하지 않음 (4×3으로 멈춤)\n"
            "• 약수 개수 공식에서 지수에 1 더하는 것 잊음"
        ),
        "design_guidelines": (
            "• 소수 판별 + 소인수분해 + 약수의 개수 연결 문항\n"
            "• 조건 역추적: 약수의 개수가 n개인 수 찾기"
        ),
    },
    "concept-m1-integer": {
        "core_concepts": (
            "• 양수·음수, 절댓값\n"
            "• 정수·유리수 사칙연산\n"
            "• 혼합 계산: 부호 규칙 (음수×음수=양수)"
        ),
        "misconceptions": (
            "• -(-3)=3 이해 못함\n"
            "• 음수의 뺄셈: -5-(-3)=-5+3=? 혼동\n"
            "• 절댓값의 크기 비교 오류"
        ),
        "design_guidelines": (
            "• 수직선 모델 활용\n"
            "• 부호 결정 문항 (곱셈/나눗셈 부호 규칙)\n"
            "• 혼합 계산 순서"
        ),
    },
    "concept-m1-expression": {
        "core_concepts": (
            "• 문자 사용: 변수, 상수, 항, 차수\n"
            "• 식의 값: 대입하여 계산\n"
            "• 일차식 계산: 동류항 정리"
        ),
        "misconceptions": (
            "• 2a를 '2와 a'라는 두 수로 인식 (곱의 약속 이해 부족)\n"
            "• 동류항이 아닌 것을 합침 (3a+2b=5ab)"
        ),
        "design_guidelines": (
            "• 대입 문항에서 음수 대입 시 괄호 사용 강조\n"
            "• 동류항 식별 후 정리"
        ),
    },
    "concept-m1-equation": {
        "core_concepts": (
            "• 등식의 성질: 양변에 같은 수를 더하기/빼기/곱하기/나누기\n"
            "• 일차방정식 풀이: 이항, 동류항 정리\n"
            "• 분수/소수 포함 방정식"
        ),
        "misconceptions": (
            "• 이항 시 부호 바꾸는 것 잊음\n"
            "• 분모 처리: 양변에 분모의 최소공배수 곱하기 누락"
        ),
        "design_guidelines": (
            "• 활용 문제: 기본/심화 (나이, 거리, 농도)\n"
            "• 분수/소수 방정식 출제"
        ),
    },
    "concept-m1-coord": {
        "core_concepts": (
            "• 순서쌍 (x, y)\n"
            "• 좌표평면: x축, y축, 원점, 4개 사분면\n"
            "• 좌표 읽기/찍기, 대칭점"
        ),
        "misconceptions": (
            "• x좌표와 y좌표 순서 혼동\n"
            "• 사분면 번호: 반시계방향으로 착각 (시계방향으로 I~IV)"
        ),
        "design_guidelines": (
            "• 대칭점 구하기 (x축, y축, 원점 대칭)\n"
            "• 좌표 읽기/찍기 문항"
        ),
    },
    "concept-m1-proportion": {
        "core_concepts": (
            "• 정비례: y=ax (a≠0), 원점 지남, 직선 그래프\n"
            "• 반비례: y=a/x (a≠0), 쌍곡선 그래프\n"
            "• 비례상수 a의 의미"
        ),
        "misconceptions": (
            "• 정비례/반비례 판별 오류: 표에서 x가 2배→y가 2배이면 정비례\n"
            "• 반비례 그래프가 x축/y축에 닿는다고 착각"
        ),
        "design_guidelines": (
            "• 그래프 해석: 비례상수 구하기\n"
            "• 정비례/반비례 판별 (표, 식, 그래프)"
        ),
    },
    "concept-m1-basic-geo": {
        "core_concepts": (
            "• 맞꼭지각: 두 직선이 만날 때 마주 보는 각 (같다)\n"
            "• 평행선과 동위각·엇각\n"
            "• 삼각형 합동 조건: SSS, SAS, ASA"
        ),
        "misconceptions": (
            "• 동위각과 엇각 혼동\n"
            "• 합동 조건에서 대응 순서 무시"
        ),
        "design_guidelines": (
            "• 평행선과 각도 계산\n"
            "• 합동 조건 판별"
        ),
    },
    "concept-m1-plane-fig": {
        "core_concepts": (
            "• 다각형의 내각의 합: (n-2)×180°\n"
            "• 외각의 합: 360°\n"
            "• 부채꼴: 호의 길이, 넓이"
        ),
        "misconceptions": (
            "• 내각과 외각 관계 (보각) 혼동\n"
            "• n각형에서 n값 잘못 세기"
        ),
        "design_guidelines": (
            "• 정n각형의 한 내각/외각 구하기\n"
            "• 부채꼴 넓이 문항"
        ),
    },
    "concept-m1-solid-fig": {
        "core_concepts": (
            "• 다면체: 꼭짓점, 모서리, 면의 관계 (오일러 공식: V-E+F=2)\n"
            "• 기둥, 뿔, 회전체\n"
            "• 겉넓이와 부피"
        ),
        "misconceptions": (
            "• 전개도 조립 실패\n"
            "• 회전체 생성 원리 이해 부족"
        ),
        "design_guidelines": (
            "• 겉넓이/부피 기본 계산\n"
            "• 전개도 문항\n"
            "• 회전체 (직사각형→원기둥, 삼각형→원뿔)"
        ),
    },
    "concept-m1-frequency": {
        "core_concepts": (
            "• 줄기와 잎 그림: 자료의 분포 파악\n"
            "• 도수분포표: 계급, 도수, 계급의 크기\n"
            "• 히스토그램과 도수분포다각형"
        ),
        "misconceptions": (
            "• 계급의 경계값 처리 (이상~미만)\n"
            "• 히스토그램과 막대그래프 혼동"
        ),
        "design_guidelines": (
            "• 도수분포표 완성하기\n"
            "• 히스토그램 해석"
        ),
    },
    "concept-m1-representative": {
        "core_concepts": (
            "• 대푯값: 평균, 중앙값, 최빈값\n"
            "• 상대도수: 각 계급의 도수/전체 도수"
        ),
        "misconceptions": (
            "• 평균=중앙값이라고 착각\n"
            "• 극단값이 평균에 미치는 영향 간과"
        ),
        "design_guidelines": (
            "• 대푯값 비교: 어떤 대푯값이 적절한가?\n"
            "• 상대도수 활용"
        ),
    },
    "concept-m1-scatter": {
        "core_concepts": (
            "• 산점도: 두 변량 사이의 관계를 점으로 표현\n"
            "• 양의 상관관계, 음의 상관관계, 상관없음"
        ),
        "misconceptions": (
            "• 상관관계=인과관계 혼동\n"
            "• 상관관계의 강도 판단 오류"
        ),
        "design_guidelines": (
            "• 산점도 보고 상관관계 판단\n"
            "• 상관관계≠인과관계 구별"
        ),
    },

    # ================================================================
    # 중학교 2학년 (10개)
    # ================================================================
    "concept-m2-rational": {
        "core_concepts": (
            "• 유리수: a/b (a,b 정수, b≠0) 꼴\n"
            "• 유한소수 조건: 기약분수의 분모 소인수가 2 또는 5뿐\n"
            "• 순환소수: 순환마디가 있는 무한소수→유리수"
        ),
        "misconceptions": (
            "• 0.999...< 1 직관적 저항\n"
            "• 순환마디 결정 오류\n"
            "• π와 순환소수 혼동: 무한소수=순환소수 잘못된 일반화"
        ),
        "design_guidelines": (
            "• 유한소수 판별: 약분→분해→판단 3단계\n"
            "• 순환소수↔분수 변환"
        ),
    },
    "concept-m2-expression": {
        "core_concepts": (
            "• 지수법칙: a^m×a^n=a^{m+n}, (a^m)^n=a^{mn}\n"
            "• 다항식 계산: 동류항, 분배법칙 전개\n"
            "• 중학교에서는 음의 지수, 0지수 미도입"
        ),
        "misconceptions": (
            "• 연산 기호와 지수법칙 불일치: a³×a²=a⁶ (곱셈→지수도 곱함)\n"
            "• 분배법칙 누락: (2x²y)³=2x⁶y³ (계수 2 거듭제곱 안 함)"
        ),
        "design_guidelines": (
            "• 지수 정의로 돌아가 시각적 확인\n"
            "• 특정 수 대입하여 검산 습관"
        ),
    },
    "concept-m2-inequality": {
        "core_concepts": (
            "• 일차부등식: 부등호로 대소 관계 표현\n"
            "• 핵심 성질: 음수를 곱/나누면 부등호 방향 바뀜\n"
            "• 연립일차부등식"
        ),
        "misconceptions": (
            "• 부등호 방향 고착화: -2x>4→x>-2 (방향 안 바꿈)\n"
            "• 해를 수직선에 표시할 때 경계값 포함 여부"
        ),
        "design_guidelines": (
            "• 실생활 맥락 모델링: 요금제 비교 부등식\n"
            "• 음수 곱하기→부등호 반전 강조"
        ),
    },
    "concept-m2-simultaneous": {
        "core_concepts": (
            "• 미지수 2개, 방정식 2개\n"
            "• 가감법: 한 문자 소거\n"
            "• 대입법: 한 식을 다른 식에 대입\n"
            "• 해의 특수성: 해 1개(일반), 해 없음(불능), 해 무수히 많음(부정)"
        ),
        "misconceptions": (
            "• 대수적 해와 그래프 교점 연결 못함\n"
            "• 가감법에서 부호 처리 오류"
        ),
        "design_guidelines": (
            "• 가감법 vs 대입법 효율성 판단\n"
            "• 해의 특수성 문항"
        ),
    },
    "concept-m2-linear-func": {
        "core_concepts": (
            "• 일차함수: y=ax+b (a≠0)\n"
            "• 기울기(a): Δy/Δx = 변화율\n"
            "• 절편: x절편, y절편\n"
            "• 일차함수↔일차방정식: ax+by+c=0의 그래프는 직선"
        ),
        "misconceptions": (
            "• 기울기 크기 비교 혼동: -2와 -5 중 어느 것이 더 가파른지\n"
            "• 절편과 좌표 혼동: x절편 3을 엉뚱한 곳에 표시\n"
            "• x=2(세로선)를 함수로 착각"
        ),
        "design_guidelines": (
            "• 기울기·절편 변화→그래프 변화 관찰\n"
            "• 상수함수 y=3과 x=2의 차이"
        ),
    },
    "concept-m2-triangle": {
        "core_concepts": (
            "• 이등변삼각형: 정의(두 변 같음)→성질(두 밑각 같음)\n"
            "• 외심: 세 변의 수직이등분선 교점, 외접원의 중심\n"
            "• 내심: 세 내각의 이등분선 교점, 내접원의 중심"
        ),
        "misconceptions": (
            "• 정의와 성질 혼동: 직사각형의 정의를 성질로 답함\n"
            "• 외심/내심 혼동: 외심 작도 시 각의 이등분선 사용\n"
            "• 둔각삼각형 외심이 삼각형 외부에 존재함을 잊음"
        ),
        "design_guidelines": (
            "• 정당화 활동: 왜 그런가? 질문\n"
            "• 외심·내심 구분 문항"
        ),
    },
    "concept-m2-quadrilateral": {
        "core_concepts": (
            "• 사각형 계통도: 사각형→평행사변형→직사각형/마름모→정사각형\n"
            "• 평행사변형 조건: 대변의 길이 같음, 대각의 크기 같음 등\n"
            "• 특수 사각형의 성질"
        ),
        "misconceptions": (
            "• 평행사변형 조건 중 하나만 만족하면 된다고 착각\n"
            "• 사각형 포함 관계 이해 부족"
        ),
        "design_guidelines": (
            "• 평행사변형이 되기 위한 조건 확인\n"
            "• 사각형 포함 관계 문항"
        ),
    },
    "concept-m2-similarity": {
        "core_concepts": (
            "• 닮음 조건: SSS, SAS, AA 닮음\n"
            "• 닮음비: m:n이면 넓이 m²:n², 부피 m³:n³\n"
            "• 평행선과 선분의 비"
        ),
        "misconceptions": (
            "• 대응변 찾기 오류: 회전/뒤집힌 도형에서 잘못 짝지음\n"
            "• 부분 대 전체 비 혼동"
        ),
        "design_guidelines": (
            "• 도형 분리 후 같은 방향으로 다시 그리기 전략\n"
            "• 닮음비→넓이비→부피비 연결"
        ),
    },
    "concept-m2-pythagoras": {
        "core_concepts": (
            "• 피타고라스 정리: a²+b²=c² (c는 빗변)\n"
            "• 직각삼각형 판별: a²+b²=c²이면 직각\n"
            "• 특수 직각삼각형: 3-4-5, 5-12-13, 1-1-√2, 1-√3-2"
        ),
        "misconceptions": (
            "• 빗변이 아닌 변을 c에 대입\n"
            "• a²+b²=c²에서 양변 제곱근 계산 오류"
        ),
        "design_guidelines": (
            "• 좌표평면에서 두 점 사이 거리\n"
            "• 직각삼각형 판별 문항"
        ),
    },
    "concept-m2-probability": {
        "core_concepts": (
            "• 경우의 수: 합의 법칙, 곱의 법칙\n"
            "• 확률: P(A)=사건A의 경우의 수/전체 경우의 수\n"
            "• 여사건: P(A')=1-P(A)\n"
            "• 독립 사건의 확률: P(A∩B)=P(A)×P(B)"
        ),
        "misconceptions": (
            "• 여사건 활용 미숙\n"
            "• 복원/비복원 추출 구별 못함"
        ),
        "design_guidelines": (
            "• 여사건이 효율적인 문제\n"
            "• 복원 vs 비복원 추출 비교"
        ),
    },

    # ================================================================
    # 중학교 3학년 (7개)
    # ================================================================
    "concept-m3-real-num": {
        "core_concepts": (
            "• 제곱근: x²=a의 해, 양수의 제곱근은 ±√a\n"
            "• √a: 양의 제곱근, √a²=|a|\n"
            "• 실수=유리수+무리수, 무리수=순환하지 않는 무한소수\n"
            "• 근호 계산: √a√b=√(ab), 분모의 유리화"
        ),
        "misconceptions": (
            "• 'a의 제곱근'과 '제곱근 a(√a)' 혼동: 25의 제곱근=±5, √25=5\n"
            "• √a²=a 오류: a<0일 때 √a²=|a|\n"
            "• √2+√3=√5 오류 (선형성 오류)\n"
            "• 모든 무한소수는 무리수 착각 (순환소수는 유리수)"
        ),
        "design_guidelines": (
            "• '25의 제곱근'과 '√25' 구분 문항\n"
            "• √(-3)²의 값 묻기 (답: 3)\n"
            "• 유리화의 목적 설명"
        ),
    },
    "concept-m3-factoring": {
        "core_concepts": (
            "• 곱셈공식: (a±b)²=a²±2ab+b², (a+b)(a-b)=a²-b²\n"
            "• 인수분해: 공통인수 묶기, X자형 분리법\n"
            "• 완전제곱식 판별"
        ),
        "misconceptions": (
            "• 중간항 누락: (x+3)²=x²+9 (가장 유명한 오류)\n"
            "• 불완전한 인수분해: 2x²-8=2(x²-4)에서 멈춤→2(x+2)(x-2)\n"
            "• 인수분해와 방정식 혼동: 인수분해 결과에 x=2 덧붙임"
        ),
        "design_guidelines": (
            "• (x+3)² 전개에서 중간항 확인\n"
            "• 완전제곱식 조건 문항\n"
            "• 불완전 인수분해 찾기"
        ),
    },
    "concept-m3-quad-eq": {
        "core_concepts": (
            "• 이차방정식: ax²+bx+c=0 (a≠0)\n"
            "• 풀이: 인수분해, 완전제곱식, 근의 공식\n"
            "• 판별식 D=b²-4ac: D>0 두 실근, D=0 중근, D<0 실근 없음\n"
            "• 근과 계수의 관계: 합=-b/a, 곱=c/a"
        ),
        "misconceptions": (
            "• 이차항 계수 조건 간과: (a-2)x²+...=0이면 a≠2 필수\n"
            "• 중근='한 개의 근'으로 오해 (서로 같은 두 실근)\n"
            "• 물리적 타당성 무시: 길이 구하는 문제에서 음수 해 답함"
        ),
        "design_guidelines": (
            "• 이차방정식이 되기 위한 조건 (a≠?)\n"
            "• 중근을 가질 조건 (D=0)\n"
            "• 활용: 음수 해 제외 여부 판단"
        ),
    },
    "concept-m3-quad-func": {
        "core_concepts": (
            "• 기본형 y=ax²: 원점 꼭짓점, y축이 축\n"
            "• 표준형 y=a(x-p)²+q: 꼭짓점 (p,q)\n"
            "• 일반형 y=ax²+bx+c\n"
            "• 최대·최소: a>0이면 최솟값 q, a<0이면 최댓값 q"
        ),
        "misconceptions": (
            "• 평행이동 부호 혼동: x축으로 p만큼→y=a(x-p)² (부호 반대)\n"
            "• 최댓값/최솟값을 x좌표로 답함 (함숫값 y로 답해야 함)\n"
            "• b의 부호 결정: 축 x=-b/2a의 위치로 추론"
        ),
        "design_guidelines": (
            "• 표준형→꼭짓점, 축 찾기\n"
            "• '최댓값은?' 질문에 y값으로 답하는지 확인\n"
            "• 그래프 보고 a,b,c 부호 판별"
        ),
    },
    "concept-m3-trig": {
        "core_concepts": (
            "• 정의: sinA=높이/빗변, cosA=밑변/빗변, tanA=높이/밑변\n"
            "• 특수각: 30°, 45°, 60° 값\n"
            "• 삼각형 넓이: S=½ab sinC"
        ),
        "misconceptions": (
            "• 변의 위치 착각: 회전된 삼각형에서 밑변/높이 못 찾음\n"
            "• 빗변=직각의 대변 (항상 고정)\n"
            "• 삼각비 크기 관계 혼동: sin50° vs tan50°"
        ),
        "design_guidelines": (
            "• 회전된 삼각형에서 삼각비 구하기\n"
            "• 특수각 삼각비 값 유도 과정\n"
            "• sin, cos, tan 크기 비교"
        ),
    },
    "concept-m3-circle": {
        "core_concepts": (
            "• 원주각과 중심각: 같은 호에 대해 원주각=½×중심각\n"
            "• 같은 호에 대한 원주각은 모두 같음\n"
            "• 반원의 원주각=90°\n"
            "• 원에 내접하는 사각형: 대각의 합=180°\n"
            "• 접선의 성질: 접점에서 반지름과 수직"
        ),
        "misconceptions": (
            "• 접선 문제에서 직각 표시 안 함\n"
            "• 중심각 착각: 원 내부의 아무 점을 중심으로 착각\n"
            "• 이등변삼각형 간과: 반지름 연결하면 이등변삼각형"
        ),
        "design_guidelines": (
            "• 원주각과 중심각 구분\n"
            "• 반원의 원주각=90° 활용\n"
            "• 내접사각형 대각의 합"
        ),
    },
    "concept-m3-statistics": {
        "core_concepts": (
            "• 대푯값: 평균, 중앙값, 최빈값\n"
            "• 산포도: 분산, 표준편차\n"
            "• 산점도와 상관관계\n"
            "• 상자그림(Box Plot): 최솟값, Q1, 중앙값, Q3, 최댓값"
        ),
        "misconceptions": (
            "• 표준편차 계산에서 (n-1) vs n 혼동\n"
            "• 상관관계=인과관계 혼동\n"
            "• 상자그림에서 사분위수 범위(IQR) 해석 오류"
        ),
        "design_guidelines": (
            "• 상자그림 해석 문항\n"
            "• 산점도 보고 상관관계 판단\n"
            "• 분산/표준편차 계산"
        ),
    },

    # ================================================================
    # 공통수학1 - 고1 1학기 (4개)
    # ================================================================
    "concept-h1-polynomial": {
        "core_concepts": (
            "• 다항식 연산: 내림차순 정리, 덧셈/뺄셈/곱셈\n"
            "• 항등식: 모든 x에 대해 성립하는 등식, 미정계수법\n"
            "• 나머지정리: P(x)를 (x-α)로 나눈 나머지 = P(α)\n"
            "• 인수분해: 공식 변형, 치환"
        ),
        "misconceptions": (
            "• 항등식과 방정식 혼동: x에 대한 식 보면 무조건 x값 구하려 함\n"
            "• 문자의 역할 혼동: 변수 vs 상수 구분 실패"
        ),
        "design_guidelines": (
            "• 항등식 조건에서 미정계수 구하기\n"
            "• 나머지정리 활용 (함숫값 해석)\n"
            "• 지나치게 복잡한 인수분해 지양"
        ),
    },
    "concept-h1-equation": {
        "core_concepts": (
            "• 복소수: 허수단위 i (i²=-1), 켤레복소수\n"
            "• 이차방정식: 판별식 D, 근과 계수의 관계\n"
            "• 이차함수: 제한된 범위에서의 최대·최소\n"
            "• 이차부등식: 그래프 개형과 x축 교점으로 해석"
        ),
        "misconceptions": (
            "• 판별식 오남용: '항상 성립' 조건에서 이차항 계수>0 + D<0 동시 확인 안 함\n"
            "• 이차항 계수 조건 간과: 이차방정식이려면 a≠0\n"
            "• 다변수 최대·최소에서 변수 독립성 무시"
        ),
        "design_guidelines": (
            "• '항상 성립' 조건→이차항 계수 부호+판별식 동시 확인\n"
            "• 제한된 범위에서 최대·최소 (꼭짓점 위치 판단)\n"
            "• 이차부등식 그래프 해석"
        ),
    },
    "concept-h1-counting": {
        "core_concepts": (
            "• 합의 법칙: 배반사건일 때 n(A)+n(B)\n"
            "• 곱의 법칙: 잇달아/동시에 일어날 때 n(A)×n(B)\n"
            "• 순열 nPr: 서로 다른 n개에서 r개 택해 나열 (순서O)\n"
            "• 조합 nCr: 서로 다른 n개에서 r개 택함 (순서X)"
        ),
        "misconceptions": (
            "• 동적 선택지 축소 오류: 자릿수별 사용 가능한 숫자 풀이 변함\n"
            "• 여사건과 포함관계 오류: 포함-배제 원리 누락\n"
            "• '순서가 정해진' vs '이웃하는' vs '자리 고정' 혼동"
        ),
        "design_guidelines": (
            "• 숫자 나열하고 지워가며 카운팅 (시각적)\n"
            "• 수형도로 빠짐없이 세기\n"
            "• 포함-배제 원리 문제"
        ),
    },
    "concept-h1-matrix": {
        "core_concepts": (
            "• 행렬의 정의: 행과 열로 이루어진 수의 배열 (2×2 한정)\n"
            "• 연산: 덧셈, 뺄셈, 실수배, 곱셈\n"
            "• 제외: 역행렬, 행렬식, 연립방정식 풀이"
        ),
        "misconceptions": (
            "• 교환법칙 성립 착각: AB≠BA, (A+B)²≠A²+2AB+B²\n"
            "• 영인자 오해: A≠O, B≠O인데 AB=O 가능\n"
            "• 약분(Cancellation) 시도: AB=AC→B=C? (역행렬 없으므로 불가)"
        ),
        "design_guidelines": (
            "• AB≠BA 확인 문제\n"
            "• (A+B)² 전개 시 AB+BA 구분\n"
            "• 영인자 반례 제시"
        ),
    },

    # ================================================================
    # 공통수학2 - 고1 2학기 (10개)
    # ================================================================
    "concept-h2-plane-coord": {
        "core_concepts": (
            "• 두 점 사이의 거리: √((x₂-x₁)²+(y₂-y₁)²)\n"
            "• 선분의 내분점: (mx₂+nx₁)/(m+n)\n"
            "• 삼각형의 무게중심: 세 꼭짓점 좌표의 평균"
        ),
        "misconceptions": (
            "• 내분점 공식에서 m,n 순서 혼동\n"
            "• 거리 공식에서 제곱 빠뜨림"
        ),
        "design_guidelines": (
            "• √식을 보고 '두 점 사이의 거리'로 역추적\n"
            "• 최단 거리 문제: 대칭이동 활용"
        ),
    },
    "concept-h2-line": {
        "core_concepts": (
            "• 기울기+한 점: y-y₁=m(x-x₁)\n"
            "• 일반형: ax+by+c=0\n"
            "• 평행: 기울기 같고 절편 다름, 수직: mm'=-1\n"
            "• 점과 직선 사이의 거리: |ax₁+by₁+c|/√(a²+b²)"
        ),
        "misconceptions": (
            "• 수직 조건 단순 암기: 피타고라스 기반 유도 이해 못함\n"
            "• 수직선 x=k를 일반 직선 공식에 억지로 맞추려 함"
        ),
        "design_guidelines": (
            "• 수직 조건 유도 서술\n"
            "• 점과 직선 거리 공식 활용"
        ),
    },
    "concept-h2-circle": {
        "core_concepts": (
            "• 표준형: (x-a)²+(y-b)²=r²\n"
            "• 일반형: x²+y²+Ax+By+C=0, 원 조건: A²+B²-4C>0\n"
            "• 원과 직선: 판별식 또는 중심-직선 거리 vs 반지름 비교"
        ),
        "misconceptions": (
            "• 전략 선택 오류: 모든 문제에 판별식→계산 과부하\n"
            "• 일반형→표준형 변환 시 완전제곱식 실수"
        ),
        "design_guidelines": (
            "• 거리 공식이 효율적인 문제 설계\n"
            "• 원의 접선 (접점, 기울기, 외부 점 구분)"
        ),
    },
    "concept-h2-transform": {
        "core_concepts": (
            "• 평행이동: 점 (x,y)→(x+a,y+b), 도형 f(x-a,y-b)=0\n"
            "• 대칭이동: x축(y→-y), y축(x→-x), 원점(x→-x,y→-y)\n"
            "• y=x 대칭: (x,y)→(y,x)→역함수 연결"
        ),
        "misconceptions": (
            "• 점의 이동 vs 도형의 이동 부호 혼동\n"
            "• y=x 대칭과 역함수의 기하학적 의미 연결 못함"
        ),
        "design_guidelines": (
            "• '왜 도형 이동에서 부호가 반대인가?' 서술형\n"
            "• y=x 대칭과 역함수 연결"
        ),
    },
    "concept-h2-set": {
        "core_concepts": (
            "• 집합의 정의: 명확한 기준으로 구별되는 대상들의 모임\n"
            "• 원소(∈) vs 부분집합(⊂)\n"
            "• 교집합, 합집합, 여집합, 차집합\n"
            "• 드 모르간 법칙, 포함-배제 원리"
        ),
        "misconceptions": (
            "• ∈과 ⊂ 혼동: {1,2}∈A vs {1,2}⊂A 구별\n"
            "• 진부분집합 개수: 2ⁿ-1에서 자기 자신 제외"
        ),
        "design_guidelines": (
            "• 집합 포함 여부 판별\n"
            "• 드 모르간 법칙 활용\n"
            "• 부분집합 개수 문항"
        ),
    },
    "concept-h2-proposition": {
        "core_concepts": (
            "• 명제: 참 또는 거짓 판별 가능한 문장\n"
            "• 역, 이, 대우\n"
            "• 필요조건, 충분조건, 필요충분조건\n"
            "• 대우를 이용한 증명"
        ),
        "misconceptions": (
            "• 역과 대우 혼동\n"
            "• 필요조건↔충분조건 방향 착각\n"
            "• '모든'과 '어떤'의 부정 규칙"
        ),
        "design_guidelines": (
            "• p→q의 역/이/대우 참거짓 판별\n"
            "• 필요/충분/필요충분조건 문항\n"
            "• 대우 증명 문항"
        ),
    },
    "concept-h2-abs-inequality": {
        "core_concepts": (
            "• 절대부등식: 모든 실수에 대해 성립\n"
            "• 산술-기하 평균 부등식: (a+b)/2 ≥ √(ab)\n"
            "• 코시-슈바르츠 부등식 (비중 감소)"
        ),
        "misconceptions": (
            "• 등호 성립 조건 빠뜨림\n"
            "• 산술-기하 평균에서 a>0, b>0 조건 간과"
        ),
        "design_guidelines": (
            "• 등호 조건 포함 문항\n"
            "• 산술-기하 평균 활용 최솟값 구하기"
        ),
    },
    "concept-h2-function": {
        "core_concepts": (
            "• 함수의 정의: X의 모든 원소에 Y의 원소가 하나씩 대응\n"
            "• 일대일함수, 일대일대응\n"
            "• 합성함수: (f∘g)(x)=f(g(x))\n"
            "• 역함수: f⁻¹, f(f⁻¹(x))=x"
        ),
        "misconceptions": (
            "• 합성 순서: f∘g에서 g 먼저 적용\n"
            "• 역함수 존재 조건: 일대일대응이어야 함\n"
            "• y=f(x)의 역함수를 x와 y만 바꾸면 끝이라고 착각"
        ),
        "design_guidelines": (
            "• 합성함수 순서 확인\n"
            "• 역함수 존재 조건 판별\n"
            "• 역함수 그래프와 y=x 대칭"
        ),
    },
    "concept-h2-composite": {
        "core_concepts": (
            "• 합성함수: (f∘g)(x)=f(g(x)), 교환법칙 성립 안 됨\n"
            "• 합성함수의 분해\n"
            "• f∘f⁻¹=f⁻¹∘f=항등함수"
        ),
        "misconceptions": (
            "• f∘g=g∘f라고 착각\n"
            "• 합성 순서 무시: (f∘g)(x)에서 f를 먼저 적용"
        ),
        "design_guidelines": (
            "• f∘g≠g∘f 확인 문제\n"
            "• 합성함수에서 미지 함수 구하기"
        ),
    },
    "concept-h2-rational-irrational": {
        "core_concepts": (
            "• 유리함수: y=k/(x-a)+b, 점근선 x=a, y=b\n"
            "• 무리함수: y=√(ax+b)+c, 정의역 제한\n"
            "• 유리함수/무리함수의 그래프와 점근선/시작점"
        ),
        "misconceptions": (
            "• 점근선에 도달한다고 착각\n"
            "• 무리함수의 정의역 조건 누락\n"
            "• 유리함수 그래프의 사분면 배치 오류"
        ),
        "design_guidelines": (
            "• 점근선 구하기\n"
            "• 정의역/치역 구하기\n"
            "• 그래프 개형 문제"
        ),
    },
}


def get_prompt_context(concept_id: str) -> ConceptPromptContext | None:
    """개념 ID로 프롬프트 컨텍스트 조회."""
    return PROMPT_CONTEXTS.get(concept_id)


def format_prompt_context(concept_id: str, grade: str) -> str:
    """프롬프트 삽입용 텍스트 생성.

    Args:
        concept_id: 개념 ID (예: "concept-e3-add-sub")
        grade: 학년 (예: "elementary_3")

    Returns:
        교육과정 컨텍스트 텍스트 (없으면 빈 문자열)
    """
    sections: list[str] = []

    grade_ctx = GRADE_CONTEXT.get(grade)
    if grade_ctx:
        sections.append(f"## 학년 특성\n{grade_ctx}")

    ctx = PROMPT_CONTEXTS.get(concept_id)
    if ctx:
        if ctx.get("core_concepts"):
            sections.append(f"## 핵심 개념\n{ctx['core_concepts']}")
        if ctx.get("misconceptions"):
            sections.append(
                f"## 학생 주요 오개념 (오답 선지에 반영)\n{ctx['misconceptions']}"
            )
        if ctx.get("design_guidelines"):
            sections.append(f"## 출제 가이드라인\n{ctx['design_guidelines']}")
        if ctx.get("difficulty_guide"):
            sections.append(f"## 난이도 기준\n{ctx['difficulty_guide']}")

    return "\n\n".join(sections) if sections else ""
